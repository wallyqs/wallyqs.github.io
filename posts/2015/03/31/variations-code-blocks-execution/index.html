<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Variations around the execution of code blocks &middot; Literate Infrastructure
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-55629836-1', 'auto');
    ga('send', 'pageview');

  </script>
    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h2>
        <a href="/">
          Literate Infrastructure
        </a>
      </h2>
      <p>PaaS + Org mode</p>
      <p class="lead"><a href="https://twitter.com/wallyqs" target="_blank">@wallyqs</a></p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about.html">About</a>
          
        
      
        
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/posts/">Posts</a>
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      

    </nav>

    <p>&copy; 2015. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="post">
  <h1 class="post-title">Variations around the execution of code blocks</h1>
  <span class="post-date">31 Mar 2015</span>
  
<p>(or <i>A list of things that run things</i>. Also, this post is a bit long&#8230;)</p>
<p>I recently stumbled upon <a href="http://www.brainpickings.org/2011/12/22/umberto-eco-on-lists/">the following quote</a> from Umberto Eco:</p>
<blockquote>
  <p>The list is the origin of culture. It’s part of the history of art and
    literature. What does culture want? To make infinity
    comprehensible. It also wants to create order — not always, but
    often. And how, as a human being, does one face infinity? How does one
    attempt to grasp the incomprehensible? Through lists, through
    catalogs, through collections in museums and through encyclopedias and
    dictionaries.</p>
</blockquote>
<p>Inspired by it, I decided to try to make one about around
  a topic that I care about a lot: <i>how to specify how to run something</i>.</p>
<p>The following is then, an enumeration of some systems or tools which
  in the end result in the execution of a <i>code block</i>
  by means of some configuration format, DSL, HTTP requests, CLI tool, etc&#8230;</p>
<p>I&#8217;ll use the term <i>code block</i> to imply that the code snippet is being
  defined outside of the runtime where it is intended to be run.</p>
<p>Also I decided to narrow down to those in the list below,
  and will be updating this post to cover them all eventually.</p>
<table>
  <tr><td>Domain</td><td>Name</td></tr>
  <tr><td></td><td></td></tr>
  <tr><td><b>Configuration Management</b></td><td>Chef, Puppet, Ansible</td></tr>
  <tr><td><b>Infrastructure</b></td><td>Packer, Terraform, Cloud Init, NixOps</td></tr>
  <tr><td><b>Isolation</b></td><td>Vagrant, Docker</td></tr>
  <tr><td><b>Workloads scheduling</b></td><td>Kubernetes, Marathon, Aurora, Heroku style, Fleet, Apcera Continuum</td></tr>
  <tr><td><b>Continuous Integration</b></td><td>Jenkins, Drone.io, Travis, Wercker</td></tr>
  <tr><td><b>Build tools, Task Runners</b></td><td>Make, Rake, Ant, Maven, Grunt, Gulp, Pants, Bazel, Gradle</td></tr>
  <tr><td><b>SSH based deploy tools</b></td><td>Capistrano, Mina, Fabric</td></tr>
  <tr><td></td><td></td></tr>
</table>
<h1>Configuration Management</h1>
<p>The purpose of these set of technologies is to make changes into a
  server like installing packages, creating users, or creating
  configuration files.  A common theme in these tooling is that they
  should be <i>idempotent</i>, meaning that each one of the commands will
  have a check to verify whether the execution has been done already or
  not, and abort if it has.</p>
<h2>Chef</h2>
<ul>
  <li>Uses: A Ruby DSL</li>
  <li>Docs:
    <ul>
      <li><a href="https://docs.chef.io/resource_execute.html">https://docs.chef.io/resource_execute.html</a></li>
      <li><a href="https://docs.chef.io/resource_bash.html">https://docs.chef.io/resource_bash.html</a></li>
    </ul>
  </li>
</ul>
<p>Chef has some <i>resources</i> which help in the execution of code blocks.
  The configuration is driven by Ruby, which allows to not only having to rely</p>
<p>The following is based on the example found <a href="https://docs.chef.io/resource_execute.html">here</a>.  We have 2 code blocks
  in this case.  The first one creates a change in the server and the second one
  checks whether that code block has been executed in the past already,
  in order to make the resource <i>idempotent</i>.</p>
<div class="highlight"><pre><span class="sx">%w{rover fido bubbers}</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">pet_name</span><span class="o">|</span>
  <span class="n">execute</span> <span class="s2">&quot;feed_pet_</span><span class="si">#{</span><span class="n">pet_name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">do</span>
    <span class="n">command</span> <span class="s2">&quot;echo &#39;Feeding: </span><span class="si">#{</span><span class="n">pet_name</span><span class="si">}</span><span class="s2">&#39;; touch &#39;/tmp/</span><span class="si">#{</span><span class="n">pet_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
    <span class="c1"># not_if { ::File.exists?(&quot;/tmp/#{pet_name}&quot;)}</span>
    <span class="n">not_if</span> <span class="s2">&quot;cat /tmp/</span><span class="si">#{</span><span class="n">pet_name</span><span class="si">}</span><span class="s2"> | grep Feeding&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
<h2>Puppet</h2>
<ul>
  <li>Uses: A special DSL</li>
  <li>Docs:
    <ul>
      <li><a href="https://docs.puppetlabs.com/references/latest/type.html#exec">https://docs.puppetlabs.com/references/latest/type.html#exec</a></li>
    </ul>
  </li>
</ul>
<p>Puppet also tries to achieve idempotent runs of the code blocks.
  According to the docs:</p>
<blockquote>
  <p>There are three main ways for an exec to be idempotent:</p>
  <p>The command itself is already idempotent. (For example, <code>apt-get update</code>.)
    The exec has an <code>onlyif</code>, <code>unless</code>, or <code>creates attribute</code>, which prevents Puppet from running the command unless some condition is met.
    The exec has <code>refreshonly =&gt; true</code>, which only allows Puppet to run the command when some other resource is changed.</p>
</blockquote>
<p>Here the execution is driven via a specialized DSL (though Ruby inspired?)
  in order to make things declarative.</p>
<p>An example of its usage:</p>
<div class="highlight"><pre><span class="vg">$my_file_arg</span> <span class="o">=</span> <span class="s1">&#39;/tmp/myarg.txt&#39;</span>

<span class="n">file</span> <span class="p">{</span> <span class="vg">$my_file_arg</span><span class="p">:</span>
  <span class="n">content</span> <span class="o">=&gt;</span> <span class="s2">&quot;Hello now&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="nb">exec</span> <span class="p">{</span><span class="s2">&quot;Use $my_file_arg&quot;</span><span class="p">:</span>
  <span class="nb">require</span> <span class="o">=&gt;</span> <span class="no">File</span><span class="o">[</span><span class="vg">$my_file_arg</span><span class="o">]</span><span class="p">,</span>
  <span class="n">command</span> <span class="o">=&gt;</span> <span class="s2">&quot;/bin/sed -i s/Hello/Bye/g $my_file_arg&quot;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
<p>Here we have 2 types of code blocks:</p>
<ul>
  <li>One expressing the contents of a file</li>
  <li>Another expressing the execution of a sed command</li>
</ul>
<h2>Ansible</h2>
<ul>
  <li>Uses: YAML</li>
  <li>Docs:
    <ul>
      <li><a href="http://docs.ansible.com/shell_module.html">http://docs.ansible.com/shell_module.html</a></li>
    </ul>
  </li>
</ul>
<p>Ansible uses <code>YAML</code> for its configuration.</p>
<p>Example from the docs</p>
<div class="highlight"><pre><span class="c1"># Execute the command in remote shell; stdout goes to the specified</span>
<span class="c1"># file on the remote.</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">shell</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">somescript.sh &gt;&gt; somelog.txt</span>

<span class="c1"># Change the working directory to somedir/ before executing the command.</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">shell</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">somescript.sh &gt;&gt; somelog.txt chdir=somedir/</span>

<span class="c1"># You can also use the &#39;args&#39; form to provide the options. This command</span>
<span class="c1"># will change the working directory to somedir/ and will only run when</span>
<span class="c1"># somedir/somelog.txt doesn&#39;t exist.</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">shell</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">somescript.sh &gt;&gt; somelog.txt</span>
  <span class="l-Scalar-Plain">args</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">chdir</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">somedir/</span>
    <span class="l-Scalar-Plain">creates</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">somelog.txt</span>
</pre></div>
<p>Here each one of the code blocks are executed by using the <code>shell</code>
  configuration directive and then its execution is modified by setting
  options like <code>creates</code> which will trigger an idempotency check and
  abort the execution of the command if the file already exists.</p>
<h1>● ● ●</h1>
<h1>Infrastructure</h1>
<p>These days there are increasing number of possibilities
  of Cloud APIs which streamline the acquisition of computing resources.
  Though this also means that the number of layers has increased as well and thus
  new types of configuration and declarative approaches need to be find
  to <i>orchestrate</i> what we want to do with those resources.</p>
<p>Some use cases are like making calls to a cloud api like AWS, Google
  Compute Engine, to get resources and chain the result to the
  execution of a code block which furthers configures what we want to do
  with the resource, or yet again persisting those changes back to
  create a new type of resource (a new container or instance type for example.)</p>
<h2>Packer</h2>
<ul>
  <li>Uses: JSON</li>
  <li>Documentation:
    <ul>
      <li><a href="https://www.packer.io/docs/command-line/build.html">https://www.packer.io/docs/command-line/build.html</a></li>
      <li><a href="https://www.packer.io/docs/provisioners/shell.html">https://www.packer.io/docs/provisioners/shell.html</a></li>
    </ul>
  </li>
</ul>
<p>Packer counts with a <code>shell provisioner</code>.</p>
<p>The description from the website notes:</p>
<blockquote>
  <p>The shell Packer provisioner provisions machines built by Packer using
    shell scripts. Shell provisioning is the easiest way to get software
    installed and configured on a machine.</p>
</blockquote>
<p>As an example, we can have <code>JSON</code> express what we want to do with the execution of the code block</p>
<div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span>
  <span class="s2">&quot;inline&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;echo foo&quot;</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
<p>The execution of the remote resource then, is driven by the <code>JSON</code> format.
  Here is a more <a href="http://blog.endpoint.com/2014/03/provisioning-development-environment_14.html">complex example</a> I could find, one that invokes <code>Ansible</code>.</p>
<div class="highlight"><pre><span class="s2">&quot;provisioners&quot;</span><span class="o">:</span> <span class="p">[</span>
  <span class="p">{</span>
    <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span>
    <span class="s2">&quot;inline&quot;</span><span class="o">:</span> <span class="p">[</span>
      <span class="s2">&quot;mkdir .ssh&quot;</span><span class="p">,</span>
      <span class="s2">&quot;echo &#39;{{user `public_key`}}&#39; &gt;&gt; .ssh/authorized_keys&quot;</span>
    <span class="p">]</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span>
    <span class="s2">&quot;execute_command&quot;</span><span class="o">:</span> <span class="s2">&quot;echo &#39;{{user `ssh_pass`}}&#39; | {{ .Vars }} sudo -E -S sh &#39;{{ .Path }}&#39;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;inline&quot;</span><span class="o">:</span> <span class="p">[</span>
      <span class="s2">&quot;add-apt-repository ppa:rquillo/ansible&quot;</span><span class="p">,</span>
      <span class="s2">&quot;apt-get update&quot;</span><span class="p">,</span>
      <span class="s2">&quot;apt-get install -y ansible&quot;</span><span class="p">,</span>
      <span class="s2">&quot;echo &#39;%sudo    ALL=(ALL)  NOPASSWD:ALL&#39; &gt;&gt; /etc/sudoers&quot;</span>
    <span class="p">]</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;ansible-local&quot;</span><span class="p">,</span>
    <span class="s2">&quot;playbook_file&quot;</span><span class="o">:</span> <span class="s2">&quot;site.yml&quot;</span>
  <span class="p">}</span>
<span class="p">]</span>
</pre></div>
<p>Here the provisioners are chained sequentially.
  One notable example is that we are now defining another sub code block named <code>execute_command</code>
  which is prepended to the execution of the original code block.</p>
<blockquote>
  <p>To many new users, the execute_command is puzzling. However, it provides an important function: customization of how the command is executed. The most common use case for this is dealing with sudo password prompts.</p>
</blockquote>
<h2>Terraform</h2>
<ul>
  <li>Uses: The special Terraform format</li>
  <li>Docs:
    <ul>
      <li><a href="https://www.terraform.io/docs/provisioners/remote-exec.html">https://www.terraform.io/docs/provisioners/remote-exec.html</a></li>
    </ul>
  </li>
</ul>
<p>Terraform is an interesting case since it recognizes the limitations
  of using JSON and YAML to drive the execution of a provisioning run.</p>
<p>The following is an example of applying puppet, also taken from the docs.</p>
<div class="highlight"><pre># Run puppet and join our Consul cluster
resource &quot;aws_instance&quot; &quot;web&quot; {
    ...
    provisioner &quot;remote-exec&quot; {
        inline = [
        &quot;puppet apply&quot;,
        &quot;consul join ${aws_instance.web.private_ip}&quot;
        ]
    }
}
</pre></div>
<p>Here we are expressing that there is going to be a computing resource
  in AWS, and then when the resource is ready, the code block would be executed
  in that environment.</p>
<h2>Cloud Config and Cloud Init</h2>
<ul>
  <li>Uses: YAML</li>
  <li>Docs:
    <ul>
      <li><a href="http://cloudinit.readthedocs.org/en/latest/topics/format.html#cloud-config-data">http://cloudinit.readthedocs.org/en/latest/topics/format.html#cloud-config-data</a></li>
      <li><a href="https://coreos.com/docs/cluster-management/setup/cloudinit-cloud-config/">https://coreos.com/docs/cluster-management/setup/cloudinit-cloud-config/</a></li>
      <li><a href="http://cloudinit.readthedocs.org/en/latest/topics/examples.html#yaml-examples">http://cloudinit.readthedocs.org/en/latest/topics/examples.html#yaml-examples</a></li>
    </ul>
  </li>
</ul>
<p>Cloud config is an interesting case.  Its execution is leveraged via <i>Convention Over Configuration</i> approach
  where anything under a certain path will be executed on the node.</p>
<p>The execution in this case is driven by <code>YAML</code> as in Kubernetes.</p>
<p>Here is an example of using <code>runcmd</code> (example taken from <a href="http://cloudinit.readthedocs.org/en/latest/topics/examples.html#yaml-examples">here</a>)</p>
<div class="highlight"><pre><span class="c1">#cloud-config</span>

<span class="c1"># run commands</span>
<span class="c1"># default: none</span>
<span class="c1"># runcmd contains a list of either lists or a string</span>
<span class="c1"># each item will be executed in order at rc.local like level with</span>
<span class="c1"># output to the console</span>
<span class="c1"># - if the item is a list, the items will be properly executed as if</span>
<span class="c1">#   passed to execve(3) (with the first arg as the command).</span>
<span class="c1"># - if the item is a string, it will be simply written to the file and</span>
<span class="c1">#   will be interpreted by &#39;sh&#39;</span>
<span class="c1">#</span>
<span class="c1"># Note, that the list has to be proper yaml, so you have to escape</span>
<span class="c1"># any characters yaml would eat (&#39;:&#39; can be problematic)</span>
<span class="l-Scalar-Plain">runcmd</span><span class="p-Indicator">:</span>
 <span class="p-Indicator">-</span> <span class="p-Indicator">[</span> <span class="nv">ls</span><span class="p-Indicator">,</span> <span class="nv">-l</span><span class="p-Indicator">,</span> <span class="nv">/</span> <span class="p-Indicator">]</span>
 <span class="p-Indicator">-</span> <span class="p-Indicator">[</span> <span class="nv">sh</span><span class="p-Indicator">,</span> <span class="nv">-xc</span><span class="p-Indicator">,</span> <span class="s">&quot;echo</span><span class="nv"> </span><span class="s">$(date)</span><span class="nv"> </span><span class="s">&#39;:</span><span class="nv"> </span><span class="s">hello</span><span class="nv"> </span><span class="s">world!&#39;&quot;</span> <span class="p-Indicator">]</span>
 <span class="p-Indicator">-</span> <span class="p-Indicator">[</span> <span class="nv">sh</span><span class="p-Indicator">,</span> <span class="nv">-c</span><span class="p-Indicator">,</span> <span class="nv">echo &quot;=========hello world&#39;=========&quot;</span> <span class="p-Indicator">]</span>
 <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ls -l /root</span>
 <span class="p-Indicator">-</span> <span class="p-Indicator">[</span> <span class="nv">wget</span><span class="p-Indicator">,</span> <span class="s">&quot;http://slashdot.org&quot;</span><span class="p-Indicator">,</span> <span class="nv">-O</span><span class="p-Indicator">,</span> <span class="nv">/tmp/index.html</span> <span class="p-Indicator">]</span>
</pre></div>
<h2>NixOps</h2>
<ul>
  <li>Uses: Nix configuration format</li>
  <li>Docs:
    <ul>
      <li>Site: <a href="http://nixos.org/nixops/">http://nixos.org/nixops/</a></li>
      <li>Manual: <a href="http://nixos.org/nixops/manual/">http://nixos.org/nixops/manual/</a></li>
      <li>There is a paper!
        <a href="http://nixos.org/~eelco/pubs/charon-releng2013-final.pdf">http://nixos.org/~eelco/pubs/charon-releng2013-final.pdf</a></li>
    </ul>
  </li>
</ul>
<p>NixOps is a super interesting solution! Here is the description that
  can be found in the site:</p>
<blockquote>
  <p>NixOps is a tool for deploying NixOS machines in a network or
    cloud. It takes as input a declarative specification of a set of
    &#8220;logical&#8221; machines and then performs any necessary steps actions to
    realise that specification: instantiate cloud machines, build and
    download dependencies, stop and start services, and so on. NixOps has
    several nice properties:</p>
</blockquote>
<p><a href="https://github.com/NixOS/nixops/blob/master/examples/mediawiki.nix">Here</a> is an example of using it to setup Mediawiki and below is an
  edited version of it.  We can find that there is an <code>installPhase</code>
  block, as well as an <code>script</code> whcih is used to prepare the postgres database.</p>
<div class="highlight"><pre>  # !!! Cut&amp;paste, extremely ugly.
  # Unpack Mediawiki and put the config file in its root directory.
  mediawikiRoot = pkgs.stdenv.mkDerivation rec {
    name= &quot;mediawiki-1.15.5&quot;;

    src = pkgs.fetchurl {
      url = &quot;http://download.wikimedia.org/mediawiki/1.15/${name}.tar.gz&quot;;
      sha256 = &quot;1d8afbdh3lsg54b69mnh6a47psb3lg978xpp277qs08yz15cjf7q&quot;;
    };

    buildPhase = &quot;true&quot;;

    installPhase =
      &#39;&#39;
        mkdir -p $out
        cp -r * $out
      &#39;&#39;;
  };

  ...

  jobs.init_mediawiki_db =
    { task = true;
      startOn = &quot;started postgresql&quot;;
      script =
        &#39;&#39;
          mkdir -p /var/lib/psql-schemas
          if ! [ -e /var/lib/psql-schemas/mediawiki-created ]; then
              ${pkgs.postgresql}/bin/createuser --no-superuser --no-createdb --no-createrole mediawiki
              ${pkgs.postgresql}/bin/createdb mediawiki -O mediawiki
              ( echo &#39;CREATE LANGUAGE plpgsql;&#39;
                cat ${mediawikiRoot}/maintenance/postgres/tables.sql
                echo &#39;CREATE TEXT SEARCH CONFIGURATION public.default ( COPY = pg_catalog.english );&#39;
                echo COMMIT
              ) | ${pkgs.postgresql}/bin/psql -U mediawiki mediawiki
              touch /var/lib/psql-schemas/mediawiki-created
          fi
        &#39;&#39;;
    };
  
 ...

};
</pre></div>
<h1>● ● ●</h1>
<h1>Isolation</h1>
<p>(Note: Not sure if isolation would be right word for these.)</p>
<p>What these do is automate the creation of another environment
  within another local environment by using virtualization or container technologies.</p>
<h2>Vagrant</h2>
<ul>
  <li>Uses: A Ruby DSL (Vagrantfile)</li>
  <li>Docs:
    <ul>
      <li><a href="https://docs.vagrantup.com/v2/provisioning/basic_usage.html">https://docs.vagrantup.com/v2/provisioning/basic_usage.html</a></li>
      <li><a href="https://docs.vagrantup.com/v2/push">https://docs.vagrantup.com/v2/push</a></li>
    </ul>
  </li>
</ul>
<p>Vagrant is a very popular tool which helps in the creation of local
  virtual environments.</p>
<p>Vagrant uses a <i>Vagrantfile</i> to specify the configuration and
  execution of code blocks within the created resource:</p>
<div class="highlight"><pre><span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">run</span><span class="p">:</span> <span class="s2">&quot;always&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span>
    <span class="n">s</span><span class="o">.</span><span class="n">inline</span> <span class="o">=</span> <span class="s2">&quot;echo hello&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
<p>There is also a related <code>push</code> option, which can be used to code
  blocks locally:</p>
<div class="highlight"><pre><span class="n">config</span><span class="o">.</span><span class="n">push</span><span class="o">.</span><span class="n">define</span> <span class="s2">&quot;local-exec&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">push</span><span class="o">|</span>
  <span class="n">push</span><span class="o">.</span><span class="n">inline</span> <span class="o">=</span> <span class="o">&lt;&lt;-</span><span class="no">SCRIPT</span>
<span class="sh">    scp . /var/www/website</span>
<span class="no">  SCRIPT</span>
<span class="k">end</span>
</pre></div>
<h2>Docker</h2>
<ul>
  <li>Uses: The Dockerfile format</li>
  <li>Docs:
    <ul>
      <li><a href="https://docs.docker.com/reference/builder/">https://docs.docker.com/reference/builder/</a></li>
    </ul>
  </li>
</ul>
<p>Docker uses its own basic configuration format.  Maybe due to the
  nature of Docker layers, it emphasizes running one liners via its
  <code>RUN</code> directive:</p>
<div class="highlight"><pre># Comment
RUN echo &#39;we are running some # of cool things&#39;
</pre></div>
<p>But in the end, what will continue to run is what is defined in its
  <code>ENTRYPOINT</code>:</p>
<div class="highlight"><pre>FROM debian:stable
RUN apt-get update &amp;&amp; apt-get install -y --force-yes apache2
EXPOSE 80 443
VOLUME [&quot;/var/www&quot;, &quot;/var/log/apache2&quot;, &quot;/etc/apache2&quot;]
ENTRYPOINT [&quot;/usr/sbin/apache2ctl&quot;, &quot;-D&quot;, &quot;FOREGROUND&quot;]
</pre></div>
<p>We can see that along with the execution of the code block, it is also being defined
  the folders and port mapping that are required to execute the code block.</p>
<h1>● ● ●</h1>
<h1>Build tools and Task runners</h1>
<p>These have the common functionality of chaining together
  the execution of code blocks into steps, dependencies or
  prerequisities.</p>
<p>Some of them also have notions of <i>idempotency</i> as the configuration management tooling.
  The classic example of these tools I believe it would be <code>make</code>.</p>
<h2>Make</h2>
<ul>
  <li>Uses: the <i>Makefile</i> format</li>
  <li>Docs:
    <ul>
      <li>Wikipedia entry: <a href="http://en.wikipedia.org/wiki/Makefile">http://en.wikipedia.org/wiki/Makefile</a></li>
    </ul>
  </li>
</ul>
<p>Borrowing the example of Wikipedia as well:</p>
<blockquote>
  <p>Here is a simple makefile that describes the way an executable file
    called edit depends on four object files which, in turn, depend on
    four C source and two header files.</p>
</blockquote>
<div class="highlight"><pre><span class="l-Scalar-Plain">edit</span> <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">main.o kbd.o command.o display.o</span> 
    <span class="l-Scalar-Plain">cc -o edit main.o kbd.o command.o display.o</span>
 
<span class="l-Scalar-Plain">main.o</span> <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">main.c defs.h</span>
    <span class="l-Scalar-Plain">cc -c main.c</span>
<span class="l-Scalar-Plain">kbd.o</span> <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">kbd.c defs.h command.h</span>
    <span class="l-Scalar-Plain">cc -c kbd.c</span>
<span class="l-Scalar-Plain">command.o</span> <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">command.c defs.h command.h</span>
    <span class="l-Scalar-Plain">cc -c command.c</span>
<span class="l-Scalar-Plain">display.o</span> <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">display.c defs.h</span>
    <span class="l-Scalar-Plain">cc -c display.c</span>
 
<span class="l-Scalar-Plain">clean</span> <span class="p-Indicator">:</span>
     <span class="l-Scalar-Plain">rm edit main.o kbd.o command.o display.o</span>
</pre></div>
<p>We invoke a code block using <code>make clean</code>, which will trigger the
  execution of the <code>clean</code> code block.  On the other hand,</p>
<h2>Rake</h2>
<ul>
  <li>Uses: a Ruby DSL</li>
  <li>Docs:
    <ul>
      <li><a href="https://github.com/ruby/rake">https://github.com/ruby/rake</a></li>
      <li><a href="http://ruby-doc.org/core-1.9.3/doc/rake/rakefile_rdoc.html">http://ruby-doc.org/core-1.9.3/doc/rake/rakefile_rdoc.html</a></li>
    </ul>
  </li>
</ul>
<p>From its description:</p>
<blockquote>
  <p>Rake is a Make-like program implemented in Ruby. Tasks and dependencies are specified in standard Ruby syntax.</p>
</blockquote>
<p>A simple example from the docs:</p>
<blockquote>
  <p>The following file task creates a executable program (named prog)
    given two object files name a.o and b.o.
    The tasks for creating a.o and b.o are not shown.</p>
</blockquote>
<div class="highlight"><pre><span class="n">file</span> <span class="s2">&quot;prog&quot;</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">&quot;a.o&quot;</span><span class="p">,</span> <span class="s2">&quot;b.o&quot;</span><span class="o">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">sh</span> <span class="s2">&quot;cc -o </span><span class="si">#{</span><span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">t</span><span class="o">.</span><span class="n">prerequisites</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">end</span>
</pre></div>
<p>It is also possible to run the tasks in <a href="http://devblog.avdi.org/2014/04/29/rake-part-7-multitask/">parallel</a>:</p>
<div class="highlight"><pre><span class="n">multitask</span> <span class="ss">:highlight</span> <span class="o">=&gt;</span> <span class="no">FileList</span><span class="o">[</span><span class="s2">&quot;listings/*&quot;</span><span class="o">]</span>

<span class="n">rule</span> <span class="s2">&quot;.html&quot;</span> <span class="o">=&gt;</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">f</span><span class="p">){</span> <span class="no">FileList</span><span class="o">[</span><span class="n">f</span><span class="o">.</span><span class="n">ext</span><span class="p">(</span><span class="s2">&quot;.*&quot;</span><span class="p">)</span><span class="o">].</span><span class="n">first</span> <span class="p">}</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">sh</span> <span class="s2">&quot;pygmentize -o </span><span class="si">#{</span><span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">t</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">end</span>
</pre></div>
<h2>Ant</h2>
<ul>
  <li>Uses: XML</li>
  <li>Docs:
    <ul>
      <li><a href="https://ant.apache.org/manual/using.html">https://ant.apache.org/manual/using.html</a></li>
      <li><a href="http://en.wikipedia.org/wiki/Apache_Ant">http://en.wikipedia.org/wiki/Apache_Ant</a></li>
      <li><a href="https://ant.apache.org/manual/Tasks/exec.html">https://ant.apache.org/manual/Tasks/exec.html</a></li>
    </ul>
  </li>
</ul>
<p>According to Wikipedia:</p>
<blockquote>
  <p>One of the primary aims of Ant was to solve Make&#8217;s portability problems.</p>
</blockquote>
<p>Below is an example from the wikipedia entry:</p>
<div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<span class="nt">&lt;project</span> <span class="na">name=</span><span class="s">&quot;Hello&quot;</span> <span class="na">default=</span><span class="s">&quot;compile&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;target</span> <span class="na">name=</span><span class="s">&quot;clean&quot;</span> <span class="na">description=</span><span class="s">&quot;remove intermediate files&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;delete</span> <span class="na">dir=</span><span class="s">&quot;classes&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/target&gt;</span>
    <span class="nt">&lt;target</span> <span class="na">name=</span><span class="s">&quot;clobber&quot;</span> <span class="na">depends=</span><span class="s">&quot;clean&quot;</span> <span class="na">description=</span><span class="s">&quot;remove all artifact files&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;delete</span> <span class="na">file=</span><span class="s">&quot;hello.jar&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/target&gt;</span>
    <span class="nt">&lt;target</span> <span class="na">name=</span><span class="s">&quot;compile&quot;</span> <span class="na">description=</span><span class="s">&quot;compile the Java source code to class files&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;mkdir</span> <span class="na">dir=</span><span class="s">&quot;classes&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;javac</span> <span class="na">srcdir=</span><span class="s">&quot;.&quot;</span> <span class="na">destdir=</span><span class="s">&quot;classes&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/target&gt;</span>
    <span class="nt">&lt;target</span> <span class="na">name=</span><span class="s">&quot;jar&quot;</span> <span class="na">depends=</span><span class="s">&quot;compile&quot;</span> <span class="na">description=</span><span class="s">&quot;create a Jar file for the application&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;jar</span> <span class="na">destfile=</span><span class="s">&quot;hello.jar&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;fileset</span> <span class="na">dir=</span><span class="s">&quot;classes&quot;</span> <span class="na">includes=</span><span class="s">&quot;**/*.class&quot;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;manifest&gt;</span>
                <span class="nt">&lt;attribute</span> <span class="na">name=</span><span class="s">&quot;Main-Class&quot;</span> <span class="na">value=</span><span class="s">&quot;HelloProgram&quot;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/manifest&gt;</span>
        <span class="nt">&lt;/jar&gt;</span>
    <span class="nt">&lt;/target&gt;</span>
<span class="nt">&lt;/project&gt;</span>
</pre></div>
<p>Among the XML, we can see the tasks are chained together via <code>depends</code>.</p>
<p>To execute a script, there is an <code>exec</code> task, where each one of the
  arguments to the command line are defined via an ordered list of <code>arg</code> tags:</p>
<div class="highlight"><pre><span class="nt">&lt;target</span> <span class="na">name=</span><span class="s">&quot;help&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;exec</span> <span class="na">executable=</span><span class="s">&quot;cmd&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;/c&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;ant.bat&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;-p&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/exec&gt;</span>
<span class="nt">&lt;/target&gt;</span>
</pre></div>
<h2>Maven</h2>
<ul>
  <li>Uses: XML</li>
  <li>Docs:
    <ul>
      <li><a href="https://maven.apache.org/guides/mini/guide-using-ant.html">https://maven.apache.org/guides/mini/guide-using-ant.html</a></li>
    </ul>
  </li>
</ul>
<p>Similar to Ant, an exec block in XML can be used:</p>
<div class="highlight"><pre><span class="nt">&lt;project&gt;</span>
  ...
  <span class="nt">&lt;build&gt;</span>
    <span class="nt">&lt;plugins&gt;</span>
      <span class="nt">&lt;plugin&gt;</span>
        ...
        <span class="nt">&lt;executions&gt;</span>
          <span class="nt">&lt;execution&gt;</span>
	    ...
            <span class="nt">&lt;configuration&gt;</span>
              <span class="nt">&lt;tasks&gt;</span>
                <span class="nt">&lt;exec</span>
                  <span class="na">dir=</span><span class="s">&quot;${project.basedir}&quot;</span>
                  <span class="na">executable=</span><span class="s">&quot;${project.basedir}/src/main/sh/do-something.sh&quot;</span>
                  <span class="na">failonerror=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
                  <span class="nt">&lt;arg</span> <span class="na">line=</span><span class="s">&quot;arg1 arg2 arg3 arg4&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;/exec&gt;</span>
              <span class="nt">&lt;/tasks&gt;</span>
            <span class="nt">&lt;/configuration&gt;</span>
	    ...
          <span class="nt">&lt;/execution&gt;</span>
        <span class="nt">&lt;/executions&gt;</span>
      <span class="nt">&lt;/plugin&gt;</span>
    <span class="nt">&lt;/plugins&gt;</span>
  <span class="nt">&lt;/build&gt;</span>
<span class="nt">&lt;/project&gt;</span>
</pre></div>
<h1>● ● ●</h1>
<h1>Continuous Integration</h1>
<p>CI tools help in automating the creation of build artifacts
  and running of tests from a project.  In a sense, one could say
  that they are also <i>schedulers</i> as well, though specialized in the
  domain of running tests and creating steps which result in a release (batches).</p>
<h2>Jenkins</h2>
<ul>
  <li>Uses: HTML textareas or XML.</li>
  <li>Docs:
    <ul>
      <li><a href="https://wiki.jenkins-ci.org/display/JENKINS/Home">https://wiki.jenkins-ci.org/display/JENKINS/Home</a></li>
    </ul>
  </li>
</ul>
<p>Jenkins is an established open source CI solution with a large number
  of plugins, very extensible.</p>
<p>Although most of its usage would be through HTML forms,
  there is a way to schedule Jenkins jobs via XML.
  Meaning that it is XML, the environment will be a little bit more
  unnatural than in other solutions since the code will have to be
  escaped for example so that it includes entities which make it conform
  valid XML.</p>
<h2>Travis</h2>
<ul>
  <li>Uses: YAML</li>
  <li>Docs:
    <ul>
      <li><a href="http://docs.travis-ci.com/user/build-configuration/">http://docs.travis-ci.com/user/build-configuration/</a></li>
      <li><a href="http://docs.travis-ci.com/user/customizing-the-build/">http://docs.travis-ci.com/user/customizing-the-build/</a></li>
    </ul>
  </li>
</ul>
<p>Travis is a great CI as a service solution, (which is also open source).</p>
<p>Configuration is done via a local <code>.travis.yml</code> file which is located
  at the root of a repository directory.  In the example of the docs below,
  we have 2 code blocks, one that defines a list of <code>install</code> steps
  which provision an environment so that the <code>script</code> code block is
  executed successfully.</p>
<div class="highlight"><pre><span class="l-Scalar-Plain">install</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">bundle install --path vendor/bundle</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">npm install</span>

<span class="l-Scalar-Plain">script</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">bundle exec thor build</span>
</pre></div>
<h1>● ● ●</h1>
<h1>Workloads scheduling</h1>
<p>Once having defined the infrastructure that is is desired, maybe by building upon
  the technologies in the list above, it is possible to
  create <a href="http://apprenda.com/blog/paas-wont-become-feature-iaas-unnatural/">another abstraction</a> around the computing resources so that
  those running a workload can focus on how something should be executed
  rather than than detailing how to prepare the necessary infrastructure
  so that the workload runs.  These tools are usually referred to as
  PaaS systems or some of them with more simple features are just considered <i>Schedulers</i>.</p>
<h2>Kubernetes</h2>
<ul>
  <li>Uses: JSON</li>
  <li>Docs:
    <ul>
      <li><a href="https://github.com/GoogleCloudPlatform/kubernetes/blob/master/examples/update-demo/nautilus-rc.yaml">https://github.com/GoogleCloudPlatform/kubernetes/blob/master/examples/update-demo/nautilus-rc.yaml</a></li>
    </ul>
  </li>
</ul>
<p>In the case of Kubernetes, the execution is driven via a YAML file.</p>
<p>A couple of examples below:</p>
<h4>Example: An Nginx service</h4>
<ul>
  <li>Explicitly say it is a <code>Service</code></li>
  <li>Describe the ports it will use</li>
  <li>Set a constraint about where to run the service</li>
</ul>
<div class="highlight"><pre><span class="l-Scalar-Plain">kind</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Service</span>
<span class="l-Scalar-Plain">apiVersion</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">v1beta1</span>
<span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx-example</span>
<span class="c1"># the port that this service should serve on</span>
<span class="l-Scalar-Plain">port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">8000</span>
<span class="c1"># just like the selector in the replication controller,</span>
<span class="c1"># but this time it identifies the set of pods to load balance</span>
<span class="c1"># traffic to.</span>
<span class="l-Scalar-Plain">selector</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx</span>
<span class="c1"># the container on each pod to connect to, can be a name</span>
<span class="c1"># (e.g. &#39;www&#39;) or a number (e.g. 80)</span>
<span class="l-Scalar-Plain">containerPort</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">80</span>
</pre></div>
<p>Not very clear what it is running, but it seems that
  an internal <code>containerport</code> will be exposed as the port 8000
  and that it will only be running in nodes tagged to be running <code>nginx</code> workloads.</p>
<p>The full example is <a href="https://github.com/GoogleCloudPlatform/kubernetes/commit/f1b55c04e2936fafb3c89d29dc474bb5b08f3673">here</a>.</p>
<h4>Example: A workload with a Healthcheck</h4>
<p>Here we have a container that has a <code>livenessProbe</code>,
  which can be done by either a command or a http request.</p>
<p>There are 2 code blocks: the <code>liveness-exec</code> which is going to be
  periodically writing <code>ok</code> into <code>/tmp/health</code> and its liveness probe,
  which is another code block that will be checking <code>cat /tmp/health</code></p>
<div class="highlight"><pre><span class="l-Scalar-Plain">apiVersion</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">v1beta1</span>
<span class="l-Scalar-Plain">desiredState</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">manifest</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">containers</span><span class="p-Indicator">:</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">busybox</span>
        <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">liveness</span>
        <span class="l-Scalar-Plain">livenessProbe</span><span class="p-Indicator">:</span>
          <span class="l-Scalar-Plain">exec</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span>
              <span class="p-Indicator">-</span> <span class="s">&quot;cat&quot;</span>
              <span class="p-Indicator">-</span> <span class="s">&quot;/tmp/health&quot;</span>
          <span class="l-Scalar-Plain">initialDelaySeconds</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">15</span>
        <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span>
          <span class="p-Indicator">-</span> <span class="s">&quot;/bin/sh&quot;</span>
          <span class="p-Indicator">-</span> <span class="s">&quot;-c&quot;</span>
          <span class="p-Indicator">-</span> <span class="s">&quot;echo</span><span class="nv"> </span><span class="s">ok</span><span class="nv"> </span><span class="s">&gt;</span><span class="nv"> </span><span class="s">/tmp/health;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">10;</span><span class="nv"> </span><span class="s">echo</span><span class="nv"> </span><span class="s">fail</span><span class="nv"> </span><span class="s">&gt;</span><span class="nv"> </span><span class="s">/tmp/health;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">600&quot;</span>
    <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">liveness-exec</span>
    <span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">v1beta1</span>
<span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">liveness-exec</span>
<span class="l-Scalar-Plain">kind</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Pod</span>
<span class="l-Scalar-Plain">labels</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">test</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">liveness</span>
</pre></div>
<p>We can see some of the limitations already in deciding to use <code>YAML</code>
  for this since it looks unnatural that now a command has to be
  break apart and fit into an array structure by using YAML lists.</p>
<h2>Marathon</h2>
<ul>
  <li>Uses: JSON</li>
  <li>Docs:
    <ul>
      <li><a href="https://github.com/mesosphere/marathon">https://github.com/mesosphere/marathon</a></li>
    </ul>
  </li>
</ul>
<p>In Marathon, scheduling of workloads is done via <code>JSON</code> payloads done to an HTTP API.</p>
<p>Here is <a href="https://github.com/mesosphere/marathon/blob/master/examples/bridge.json">an example</a> of starting a couple of code blocks,
  one which does a healthcheck and another one which is the job itself.</p>
<div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;bridged-webapp&quot;</span><span class="p">,</span>
  <span class="s2">&quot;cmd&quot;</span><span class="o">:</span> <span class="s2">&quot;python3 -m http.server 8080&quot;</span><span class="p">,</span>
  <span class="s2">&quot;cpus&quot;</span><span class="o">:</span> <span class="mf">0.25</span><span class="p">,</span>
  <span class="s2">&quot;mem&quot;</span><span class="o">:</span> <span class="mf">64.0</span><span class="p">,</span>
  <span class="s2">&quot;instances&quot;</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="s2">&quot;container&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;DOCKER&quot;</span><span class="p">,</span>
    <span class="s2">&quot;docker&quot;</span><span class="o">:</span> <span class="p">{</span>
      <span class="s2">&quot;image&quot;</span><span class="o">:</span> <span class="s2">&quot;python:3&quot;</span><span class="p">,</span>
      <span class="s2">&quot;network&quot;</span><span class="o">:</span> <span class="s2">&quot;BRIDGE&quot;</span><span class="p">,</span>
      <span class="s2">&quot;portMappings&quot;</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span> <span class="s2">&quot;containerPort&quot;</span><span class="o">:</span> <span class="mi">8080</span><span class="p">,</span> <span class="s2">&quot;hostPort&quot;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;servicePort&quot;</span><span class="o">:</span> <span class="mi">9000</span><span class="p">,</span> <span class="s2">&quot;protocol&quot;</span><span class="o">:</span> <span class="s2">&quot;tcp&quot;</span> <span class="p">},</span>
        <span class="p">{</span> <span class="s2">&quot;containerPort&quot;</span><span class="o">:</span> <span class="mi">161</span><span class="p">,</span> <span class="s2">&quot;hostPort&quot;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;protocol&quot;</span><span class="o">:</span> <span class="s2">&quot;udp&quot;</span><span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="s2">&quot;healthChecks&quot;</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;protocol&quot;</span><span class="o">:</span> <span class="s2">&quot;HTTP&quot;</span><span class="p">,</span>
      <span class="s2">&quot;portIndex&quot;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="s2">&quot;path&quot;</span><span class="o">:</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span>
      <span class="s2">&quot;gracePeriodSeconds&quot;</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span>
      <span class="s2">&quot;intervalSeconds&quot;</span><span class="o">:</span> <span class="mi">20</span><span class="p">,</span>
      <span class="s2">&quot;maxConsecutiveFailures&quot;</span><span class="o">:</span> <span class="mi">3</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;protocol&quot;</span><span class="o">:</span> <span class="s2">&quot;COMMAND&quot;</span><span class="p">,</span>
      <span class="s2">&quot;command&quot;</span><span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;value&quot;</span><span class="o">:</span> <span class="s2">&quot;curl -f -X GET http://$HOST:$PORT&quot;</span> <span class="p">},</span>
      <span class="s2">&quot;gracePeriodSeconds&quot;</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span>
      <span class="s2">&quot;intervalSeconds&quot;</span><span class="o">:</span> <span class="mi">20</span><span class="p">,</span>
      <span class="s2">&quot;maxConsecutiveFailures&quot;</span><span class="o">:</span> <span class="mi">3</span>
    <span class="p">}</span>

  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
<p>Via the JSON configuration we are able to say transparently modify the execution of the code block and express
  that it should be done using a runtime which has <code>python:3</code> and a certain number of ports open.</p>
<p>For the healthcheck code block, it is defined the path and one liner that should be executed
  to consider that the other job is healthy or not.  It is also expressed that after 3 failures
  something would happen, though not expressed explicitly in the configuration.</p>
<h2>Aurora</h2>
<ul>
  <li>Uses: A sophisticated DSL in Python (according to the description in the <a href="https://github.com/apache/aurora/blob/14e7b84f4303968029c3803e9b096908f3499d57/README.md">readme</a>)</li>
  <li>Docs: <a href="https://github.com/apache/aurora">https://github.com/apache/aurora</a></li>
</ul>
<p>Aurora is another Mesos based scheduler to execute code blocks.</p>
<p>An <a href="https://github.com/apache/aurora/blob/14e7b84f4303968029c3803e9b096908f3499d57/docs/tutorial.md">example</a> from the docs is below.</p>
<div class="highlight"><pre><span class="n">pkg_path</span> <span class="o">=</span> <span class="s">&#39;/vagrant/hello_world.py&#39;</span>

<span class="c"># we use a trick here to make the configuration change with</span>
<span class="c"># the contents of the file, for simplicity.  in a normal setting, packages would be</span>
<span class="c"># versioned, and the version number would be changed in the configuration.</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pkg_path</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
  <span class="n">pkg_checksum</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

<span class="c"># copy hello_world.py into the local sandbox</span>
<span class="n">install</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span>
  <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;fetch_package&#39;</span><span class="p">,</span>
  <span class="n">cmdline</span> <span class="o">=</span> <span class="s">&#39;cp </span><span class="si">%s</span><span class="s"> . &amp;&amp; echo </span><span class="si">%s</span><span class="s"> &amp;&amp; chmod +x hello_world.py&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pkg_path</span><span class="p">,</span> <span class="n">pkg_checksum</span><span class="p">))</span>

<span class="c"># run the script</span>
<span class="n">hello_world</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span>
  <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;hello_world&#39;</span><span class="p">,</span>
  <span class="n">cmdline</span> <span class="o">=</span> <span class="s">&#39;python hello_world.py&#39;</span><span class="p">)</span>

<span class="c"># describe the task</span>
<span class="n">hello_world_task</span> <span class="o">=</span> <span class="n">SequentialTask</span><span class="p">(</span>
  <span class="n">processes</span> <span class="o">=</span> <span class="p">[</span><span class="n">install</span><span class="p">,</span> <span class="n">hello_world</span><span class="p">],</span>
  <span class="n">resources</span> <span class="o">=</span> <span class="n">Resources</span><span class="p">(</span><span class="n">cpu</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ram</span> <span class="o">=</span> <span class="mi">1</span><span class="o">*</span><span class="n">MB</span><span class="p">,</span> <span class="n">disk</span><span class="o">=</span><span class="mi">8</span><span class="o">*</span><span class="n">MB</span><span class="p">))</span>

<span class="n">jobs</span> <span class="o">=</span> <span class="p">[</span>
  <span class="n">Service</span><span class="p">(</span><span class="n">cluster</span> <span class="o">=</span> <span class="s">&#39;devcluster&#39;</span><span class="p">,</span>
          <span class="n">environment</span> <span class="o">=</span> <span class="s">&#39;devel&#39;</span><span class="p">,</span>
          <span class="n">role</span> <span class="o">=</span> <span class="s">&#39;www-data&#39;</span><span class="p">,</span>
          <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;hello_world&#39;</span><span class="p">,</span>
          <span class="n">task</span> <span class="o">=</span> <span class="n">hello_world_task</span><span class="p">)</span>
<span class="p">]</span>
</pre></div>
<p>The Aurora documentation <a href="https://github.com/apache/aurora/blob/14e7b84f4303968029c3803e9b096908f3499d57/docs/tutorial.md#whats-going-on-in-that-configuration-file">has a helpful section</a> regarding about what is
  being defined in the example:</p>
<blockquote>
  <p><b>What&#8217;s Going On In That Configuration File?</b></p>
  <p>More than you might think.</p>
  <p>From a &#8220;big picture&#8221; viewpoint, it first defines two Processes. Then it defines a Task that runs the two Processes in the order specified in the Task definition, as well as specifying what computational and memory resources are available for them. Finally, it defines a Job that will schedule the Task on available and suitable machines. This Job is the sole member of a list of Jobs; you can specify more than one Job in a config file.</p>
  <p>At the Process level, it specifies how to get your code into the local sandbox in which it will run. It then specifies how the code is actually run once the second Process starts.</p>
</blockquote>
<h2>Fleet</h2>
<ul>
  <li>Uses: Same style as <code>Systemd</code></li>
  <li>Docs:
    <ul>
      <li><a href="https://github.com/coreos/fleet">https://github.com/coreos/fleet</a></li>
      <li><a href="https://coreos.com/docs/launching-containers/launching/launching-containers-fleet/">https://coreos.com/docs/launching-containers/launching/launching-containers-fleet/</a></li>
    </ul>
  </li>
</ul>
<p>The CoreOS guide has a <a href="https://coreos.com/docs/launching-containers/launching/launching-containers-fleet/">good example</a> of how to modify how to run a
  container on it:</p>
<div class="highlight"><pre><span class="o">[</span>Unit<span class="o">]</span>
<span class="nv">Description</span><span class="o">=</span>My Apache Frontend
<span class="nv">After</span><span class="o">=</span>docker.service
<span class="nv">Requires</span><span class="o">=</span>docker.service

<span class="o">[</span>Service<span class="o">]</span>
<span class="nv">TimeoutStartSec</span><span class="o">=</span>0
<span class="nv">ExecStartPre</span><span class="o">=</span>-/usr/bin/docker <span class="nb">kill </span>apache1
<span class="nv">ExecStartPre</span><span class="o">=</span>-/usr/bin/docker rm apache1
<span class="nv">ExecStartPre</span><span class="o">=</span>/usr/bin/docker pull coreos/apache
<span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/docker run -rm --name apache1 -p 80:80 coreos/apache /usr/sbin/apache2ctl -D FOREGROUND
<span class="nv">ExecStop</span><span class="o">=</span>/usr/bin/docker stop apache1

<span class="o">[</span>X-Fleet<span class="o">]</span>
<span class="nv">Conflicts</span><span class="o">=</span>apache@*.service
</pre></div>
<p>By using <code>ExecStartPre</code>, the lines from a code block will accumulate
  and executed before running the container which has an Apache service.
  It is also specified that such code block should not be run in the
  same machine by using the <code>Conflicts</code> option (more options <a href="https://coreos.com/docs/launching-containers/launching/fleet-unit-files/">here</a>).</p>
<h2>Heroku</h2>
<ul>
  <li>Uses: Procfiles and Buildpacks</li>
  <li>Docs:
    <ul>
      <li><a href="https://devcenter.heroku.com/articles/procfile">https://devcenter.heroku.com/articles/procfile</a></li>
      <li><a href="https://devcenter.heroku.com/articles/buildpacks">https://devcenter.heroku.com/articles/buildpacks</a></li>
    </ul>
  </li>
</ul>
<p>Actually is no longer just a hosting option, but a set of practices
  which inspired other technologies like Flynn, Deis.io, Dokku and Cloudfoundry.</p>
<p>In case of Flynn, the code block execution is done via <code>Procfiles</code> (<a href="https://flynn.io/docs">link</a>).</p>
<p>A Procfile based application modifies the execution of a code block by
  prepending a tag to the start command. For example:</p>
<div class="highlight"><pre><span class="nv">$ </span>cat Procfile
web: node web.js
</pre></div>
<p>In order to modify the environment of where that command would be run,
  <a href="https://devcenter.heroku.com/articles/buildpacks">buildpacks</a> are used.  This is done by calling 3 possible other code
  blocks: detect, compile and release (<a href="https://devcenter.heroku.com/articles/buildpack-api">docs</a>).</p>
<ul>
  <li><code>detect</code> sends to stdout the type of application</li>
  <li><code>compile</code> makes changes to the environment which will persisted
    for code blocks which will be run in the same environment later on.</li>
  <li><code>release</code> communicates YAML back to the scheduler for later reuse
    For example, from the Clojure <a href="https://github.com/heroku/heroku-buildpack-clojure/blob/master/bin/release">buildpack</a>:
<div class="highlight"><pre><span class="l-Scalar-Plain">cat &lt;&lt;EOF</span>
<span class="nn">---</span>
<span class="l-Scalar-Plain">config_vars</span><span class="p-Indicator">:</span>
<span class="l-Scalar-Plain">default_process_types</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">web</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">lein trampoline run</span>
<span class="l-Scalar-Plain">EOF</span>
</pre></div>
  </li>
</ul>
<h2>Atlas</h2>
<ul>
  <li>Uses: JSON
    <ul>
      <li><a href="https://atlas.hashicorp.com/features/develop">https://atlas.hashicorp.com/features/develop</a></li>
      <li><a href="https://atlas.hashicorp.com/help/getting-started/package-services-with-artifacts">https://atlas.hashicorp.com/help/getting-started/package-services-with-artifacts</a></li>
    </ul>
  </li>
</ul>
<p>Atlas is a gestalt of all the products from Hashicorp which
  in the end runs a workload on a specified infrastructure.</p>
<p>Below is an example of how something is run (taken from the docs
  <a href="https://atlas.hashicorp.com/help/getting-started/package-services-with-artifacts">here</a>).</p>
<div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;builders&quot;</span><span class="o">:</span> <span class="p">[{</span>
        <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;amazon-ebs&quot;</span><span class="p">,</span>
        <span class="s2">&quot;access_key&quot;</span><span class="o">:</span> <span class="s2">&quot;ACCESS_KEY_HERE&quot;</span><span class="p">,</span>
        <span class="s2">&quot;secret_key&quot;</span><span class="o">:</span> <span class="s2">&quot;SECRET_KEY_HERE&quot;</span><span class="p">,</span>
        <span class="s2">&quot;region&quot;</span><span class="o">:</span> <span class="s2">&quot;us-east-1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;source_ami&quot;</span><span class="o">:</span> <span class="s2">&quot;ami-de0d9eb7&quot;</span><span class="p">,</span>
        <span class="s2">&quot;instance_type&quot;</span><span class="o">:</span> <span class="s2">&quot;t1.micro&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ssh_username&quot;</span><span class="o">:</span> <span class="s2">&quot;ubuntu&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ami_name&quot;</span><span class="o">:</span> <span class="s2">&quot;atlas-example {{timestamp}}&quot;</span>
    <span class="p">}],</span>
    <span class="s2">&quot;push&quot;</span><span class="o">:</span> <span class="p">{</span>
      <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;&lt;username&gt;/example-build-configuration&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;provisioners&quot;</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span>
        <span class="s2">&quot;inline&quot;</span><span class="o">:</span> <span class="p">[</span>
            <span class="s2">&quot;sleep 30&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sudo apt-get update&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sudo apt-get install apache2 -y&quot;</span>
        <span class="p">]</span>
    <span class="p">}],</span>
    <span class="s2">&quot;post-processors&quot;</span><span class="o">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;atlas&quot;</span><span class="p">,</span>
        <span class="s2">&quot;artifact&quot;</span><span class="o">:</span> <span class="s2">&quot;&lt;username&gt;/example-artifact&quot;</span><span class="p">,</span>
        <span class="s2">&quot;artifact_type&quot;</span><span class="o">:</span> <span class="s2">&quot;aws.ami&quot;</span><span class="p">,</span>
        <span class="s2">&quot;metadata&quot;</span><span class="o">:</span> <span class="p">{</span>
          <span class="s2">&quot;created_at&quot;</span><span class="o">:</span> <span class="s2">&quot;{{timestamp}}&quot;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
<h2>Apcera Continuum</h2>
<ul>
  <li>Uses: Same configuration format as <code>gnatsd</code></li>
  <li>Docs:
    <ul>
      <li><a href="http://docs.apcera.com/introduction/introducing-continuum/">http://docs.apcera.com/introduction/introducing-continuum/</a></li>
    </ul>
  </li>
</ul>
<p>Continuum is easily one of my favorite platforms today.  It is very
  futuristic and waaaay ahead of anything else that exists today.</p>
<p>Not only is it possible to specify directives to modify how
  something is run, it is possible to script the interactions
  from the platform itself!</p>
<p>To define what is being executed or packaged (<a href="https://github.com/apcera/continuum-package-scripts/blob/master/runtimes/go-1.3.conf">example</a>),
  a <code>build</code> blocks are used:</p>
<div class="highlight"><pre>environment { &quot;PATH&quot;:    &quot;/opt/apcera/go1.3.linux-amd64/bin:$PATH&quot;,
              &quot;GOROOT&quot;:  &quot;/opt/apcera/go1.3.linux-amd64&quot;,
              &quot;GOPATH&quot;:  &quot;/opt/apcera/go&quot; }

build (
      export GOPATH=/opt/apcera/go
      (
            sudo mkdir -p $GOPATH
            sudo chown -R `id -u` $GOPATH
            cd $GOPATH
            mkdir -p src bin pkg
      )
      export INSTALLPATH=/opt/apcera/go1.3.linux-amd64
      tar -zxf go1.3.linux-amd64.tar.gz
      sudo mkdir -p ${INSTALLPATH}
      sudo cp -a go/. ${INSTALLPATH}

      # Install godeps
      export PATH=$INSTALLPATH/bin:$PATH
      export GOROOT=$INSTALLPATH
      go get github.com/apcera/godep
)
</pre></div>
<p>And for the execution of a code block, options like <code>start_cmd</code>
  and <code>resources</code> <a href="https://github.com/apcera/continuum-sample-apps/blob/master/example-ruby-manifest/services.conf">are used</a>.</p>
<div class="highlight"><pre><span class="c1"># The command to start the app. If unset the stager will</span>
<span class="c1"># attempt to auto detect the start command based on the</span>
<span class="c1"># app framework used.</span>
<span class="l-Scalar-Plain">start_cmd</span><span class="p-Indicator">:</span> <span class="s">&quot;bundle</span><span class="nv"> </span><span class="s">exec</span><span class="nv"> </span><span class="s">rackup</span><span class="nv"> </span><span class="s">config.ru</span><span class="nv"> </span><span class="s">-p</span><span class="nv"> </span><span class="s">$PORT&quot;</span>

<span class="c1"># Resources allocated to the job.</span>
<span class="l-Scalar-Plain">resources {</span>
  <span class="l-Scalar-Plain"># CPU allocated to the job. Calculated in ms/s.</span>
  <span class="l-Scalar-Plain"># Default</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0, uncapped</span>
  <span class="l-Scalar-Plain">cpu</span><span class="p-Indicator">:</span> <span class="s">&quot;0&quot;</span>

  <span class="c1"># Disk space to allow for the application.</span>
  <span class="c1"># Default: 1024MB</span>
  <span class="l-Scalar-Plain">disk_space</span><span class="p-Indicator">:</span> <span class="s">&quot;768MB&quot;</span>

  <span class="c1"># Memory the job can use.</span>
  <span class="c1"># Default: 256MB</span>
  <span class="l-Scalar-Plain">memory</span><span class="p-Indicator">:</span> <span class="s">&quot;256MB&quot;</span>

  <span class="c1"># Network bandwidth allocated to the job.</span>
  <span class="c1"># Default: 5Mbps</span>
  <span class="l-Scalar-Plain">network_bandwidth</span><span class="p-Indicator">:</span> <span class="s">&quot;10Mbps&quot;</span>
<span class="err">}</span>
</pre></div>
<p>Also interesting is that the platform makes it possible to parameterize
  files providing info about how the file is being run.</p>
<p>In the example below, <code>uuid</code> and <code>name</code> is information that comes
  directly from the platform.</p>
<div class="highlight"><pre>  <span class="c1"># Link: https://github.com/apcera/continuum-sample-apps/blob/master/example-ruby-manifest/app.rb#L18</span>
  <span class="n">get</span> <span class="s2">&quot;/template&quot;</span> <span class="k">do</span>
    <span class="s2">&quot;scalars:&lt;br /&gt;</span>
<span class="s2">uuid: {{uuid}}&lt;br /&gt;</span>
<span class="s2">name: {{name}}&lt;br /&gt;</span>
<span class="s2">num_instances: {{num_instances}}&lt;br /&gt;</span>
<span class="s2">cpu: {{cpu}}&lt;br /&gt;</span>
<span class="s2">memory: {{memory}}&lt;br /&gt;</span>
<span class="s2">disk: {{disk}}&lt;br /&gt;</span>
<span class="s2">...*edited*...</span>
<span class="s2">&quot;</span>
  <span class="k">end</span>
</pre></div>
<h2>Cron</h2>
<ul>
  <li>Uses: Cron configuration format</li>
</ul>
<p>Just for completeness, the classic cron syntax. From <a href="http://en.wikipedia.org/wiki/Cron">Wikipedia</a>:</p>
<blockquote>
  <p>The following specifies that the Apache error log clears at one minute
    past midnight (00:01) of every day of the month, or every day of the
    week, assuming that the default shell for the cron user is Bourne
    shell compliant:</p>
  <pre class="example">
1 0 * * *  printf &gt; /var/log/apache/error_log
  </pre>
</blockquote>
<h2>Conclusions</h2>
<p>Again, what I found interesting of all of these systems and tooling,
  is that they are variations around the same idea: wrap some configuration
  around the execution of a code block to transparently add some behavior
  to its execution.</p>
<p>It is impressive that there are so many different takes on this issue.
  even though that in essence what is happening is more or less the same.</p>
<p>As an alternative, see for example what is being done in the
  <a href="https://github.com/aphyr/jepsen/blob/master/jepsen/etcd/src/jepsen/system/etcd.clj#L81">Jepsen tests</a>, where there are no code blocks and they have been
  assimilated into the code itself.</p>
<div class="highlight"><pre><span class="p">(</span><span class="kd">defn </span><span class="nv">db</span> <span class="p">[]</span>
  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">running</span> <span class="p">(</span><span class="nf">atom</span> <span class="nv">nil</span><span class="p">)]</span> <span class="c1">; A map of nodes to whether they&#39;re running</span>
    <span class="p">(</span><span class="nf">reify</span> <span class="nv">db/DB</span>
      <span class="p">(</span><span class="nf">setup!</span> <span class="p">[</span><span class="nv">this</span> <span class="nb">test </span><span class="nv">node</span><span class="p">]</span>
        <span class="c1">; You&#39;ll need debian testing for this, cuz etcd relies on go 1.2</span>
        <span class="p">(</span><span class="nf">debian/install</span> <span class="p">[</span><span class="ss">:golang</span> <span class="ss">:git-core</span><span class="p">])</span>

        <span class="p">(</span><span class="nf">c/su</span>
          <span class="p">(</span><span class="nf">c/cd</span> <span class="s">&quot;/opt&quot;</span>
                <span class="p">(</span><span class="nb">when-not </span><span class="p">(</span><span class="nf">cu/file?</span> <span class="s">&quot;etcd&quot;</span><span class="p">)</span>
                  <span class="p">(</span><span class="nf">info</span> <span class="nb">node </span><span class="s">&quot;cloning etcd&quot;</span><span class="p">)</span>
                  <span class="p">(</span><span class="nf">c/exec</span> <span class="ss">:git</span> <span class="ss">:clone</span> <span class="s">&quot;https://github.com/coreos/etcd&quot;</span><span class="p">)))</span>

          <span class="p">(</span><span class="nf">c/cd</span> <span class="s">&quot;/opt/etcd&quot;</span>
                <span class="p">(</span><span class="nb">when-not </span><span class="p">(</span><span class="nf">cu/file?</span> <span class="s">&quot;bin/etcd&quot;</span><span class="p">)</span>
                  <span class="p">(</span><span class="nf">info</span> <span class="nb">node </span><span class="s">&quot;building etcd&quot;</span><span class="p">)</span>
                  <span class="p">(</span><span class="nf">c/exec</span> <span class="p">(</span><span class="nf">c/lit</span> <span class="s">&quot;./build&quot;</span><span class="p">))))</span>
</pre></div>
<h1>EOF</h1>
<hr />



</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/posts/2015/02/26/mesos-tokyo/">
            Talked at the Tokyo Mesos Meetup #1
            <small>26 Feb 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/posts/2015/02/25/ob-mesos/">
            Running Org Babel workloads on top of Mesos with Go and the Docker Containerizer
            <small>25 Feb 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/posts/2014/12/25/learning-go-backwards/">
            About type switch usage in Go
            <small>25 Dec 2014</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>

  </body>
</html>
