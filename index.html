<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Literate Infrastructure &middot; PaaS + Org mode
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-55629836-1', 'auto');
    ga('send', 'pageview');

  </script>
    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h2>
        <a href="/">
          Literate Infrastructure
        </a>
      </h2>
      <p>PaaS + Org mode</p>
      <p class="lead"><a href="https://twitter.com/wallyqs" target="_blank">@wallyqs</a></p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item active" href="/">Home</a>

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about.html">About</a>
          
        
      
        
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/posts/">Posts</a>
          
        
      
        
          
        
      
        
          
        
      

    </nav>

    <p>&copy; 2015. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/posts/2014/12/25/learning-go-backwards/">
        About type switch usage in Go
      </a>
    </h1>

    <span class="post-date">25 Dec 2014</span>

    
<p>One of the features that I have been relying a lot in Go is the <a href="https://golang.org/doc/effective_go.html#type_switch">type switch</a>.
  This feature is specially useful when using interfaces since it helps us avoid having to do type assertions all the time.</p>
<p>A couple of examples below.</p>
<h3>Example #1</h3>
<p>Let&#8217;s suppose that we have 3 types <code>A</code>, <code>B</code> &amp; <code>C</code>,
  where each one of these types can be assigned a <code>Name</code>:</p>
<div class="highlight"><pre><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
  <span class="s">&quot;fmt&quot;</span>
  <span class="s">&quot;reflect&quot;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">A</span> <span class="kd">struct</span> <span class="p">{</span> <span class="nx">Name</span> <span class="kt">string</span> <span class="p">}</span>
<span class="kd">type</span> <span class="nx">B</span> <span class="kd">struct</span> <span class="p">{</span> <span class="nx">Name</span> <span class="kt">string</span> <span class="p">}</span>
<span class="kd">type</span> <span class="nx">C</span> <span class="kd">struct</span> <span class="p">{</span> <span class="nx">Name</span> <span class="kt">string</span> <span class="p">}</span>
</pre></div>
<p>And we put them inside of a slice which can contain <code>interfaces</code>:</p>
<div class="highlight"><pre><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>

  <span class="nx">a</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">A</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="s">&quot;A&quot;</span><span class="p">}</span>
  <span class="nx">b</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">B</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="s">&quot;B&quot;</span><span class="p">}</span>
  <span class="nx">c</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">C</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="s">&quot;C&quot;</span><span class="p">}</span>

  <span class="nx">t</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kd">interface</span><span class="p">{},</span> <span class="mi">0</span><span class="p">)</span>
  <span class="nx">t</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">a</span><span class="p">)</span>
  <span class="nx">t</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span>
  <span class="nx">t</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span>
</pre></div>
<h4>Without using <code>type switch</code></h4>
<p>We would end up doing something like this:</p>
<div class="highlight"><pre><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;--- without type switching&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">thing</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">t</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="nx">thing</span><span class="p">.(</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">*</span><span class="nx">A</span><span class="p">:</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">thing</span><span class="p">),</span> <span class="s">&quot;is of type A. Name is:&quot;</span><span class="p">,</span> <span class="nx">thing</span><span class="p">.(</span><span class="o">*</span><span class="nx">A</span><span class="p">).</span><span class="nx">Name</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">*</span><span class="nx">B</span><span class="p">:</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">thing</span><span class="p">),</span> <span class="s">&quot;is of type B. Name is:&quot;</span><span class="p">,</span> <span class="nx">thing</span><span class="p">.(</span><span class="o">*</span><span class="nx">B</span><span class="p">).</span><span class="nx">Name</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">*</span><span class="nx">C</span><span class="p">:</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">thing</span><span class="p">),</span> <span class="s">&quot;is of type C. Name is:&quot;</span><span class="p">,</span> <span class="nx">thing</span><span class="p">.(</span><span class="o">*</span><span class="nx">C</span><span class="p">).</span><span class="nx">Name</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<h5>Results</h5>
<pre class="example">
--- without type switching
*main.A is of type A. Name is: A
*main.B is of type B. Name is: B
*main.C is of type C. Name is: C
</pre>
<h4>Using a <code>type switch</code></h4>
<p>Makes things a little more bearable:</p>
<div class="highlight"><pre><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;--- type switching on the item&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">thing</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">t</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="nx">o</span> <span class="o">:=</span> <span class="nx">thing</span><span class="p">.(</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">*</span><span class="nx">A</span><span class="p">:</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">o</span><span class="p">),</span> <span class="s">&quot;is of type A. Name is:&quot;</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">*</span><span class="nx">B</span><span class="p">:</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">o</span><span class="p">),</span> <span class="s">&quot;is of type B. Name is:&quot;</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">*</span><span class="nx">C</span><span class="p">:</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">o</span><span class="p">),</span> <span class="s">&quot;is of type C. Name is:&quot;</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<h5>Results</h5>
<pre class="example">
--- type switching on the item
*main.A is of type A. Name is: A
*main.B is of type B. Name is: B
*main.C is of type C. Name is: C
</pre>
<h3>Example #2</h3>
<p>Let&#8217;s see how far we can take it.
  Now, let&#8217;s suppose that we want to handle A and B the same way.</p>
<h4>Using <code>type switch</code>, it works too</h4>
<p>Since we want to handle <code>A</code> and <code>B</code> the same way, we could think
  that we could group them into the same <code>case</code>, which would work:</p>
<div class="highlight"><pre><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;--- Grouping A and B: &quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">thing</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">t</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="nx">o</span> <span class="o">:=</span> <span class="nx">thing</span><span class="p">.(</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">*</span><span class="nx">A</span><span class="p">,</span> <span class="o">*</span><span class="nx">B</span><span class="p">:</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">o</span><span class="p">),</span> <span class="s">&quot;is of type A or B.&quot;</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">*</span><span class="nx">C</span><span class="p">:</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">o</span><span class="p">),</span> <span class="s">&quot;is of type C.&quot;</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<h5>Results</h5>
<pre class="example">
*main.A is of type A or B.
*main.B is of type A or B.
*main.C is of type C.
</pre>
<h4>Until it doesn&#8217;t</h4>
<p>Let&#8217;s suppose that we want to inspect the value of the <code>Name</code> field. Then it breaks:</p>
<div class="highlight"><pre><span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">thing</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">t</span> <span class="p">{</span>
	<span class="k">switch</span> <span class="nx">o</span> <span class="o">:=</span> <span class="nx">thing</span><span class="p">.(</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="o">*</span><span class="nx">A</span><span class="p">,</span> <span class="o">*</span><span class="nx">B</span><span class="p">:</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">o</span><span class="p">),</span> <span class="s">&quot;is of type A or B. Name is:&quot;</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
	<span class="k">case</span> <span class="o">*</span><span class="nx">C</span><span class="p">:</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">o</span><span class="p">),</span> <span class="s">&quot;is of type C. Name is:&quot;</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>The above would throw the following error:</p>
<pre class="example">
o.Name undefined (type interface {} has no field or method Name)
</pre>
<h4>Back to <code>interface</code></h4>
<p>What happened here is that by trying to group <code>A</code>, <code>B</code> types, we ended up again
  with an <code>interface</code>, so we cannot rely on the first type switch anymore.</p>
<p>We could type switch once more time then:</p>
<div class="highlight"><pre><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;--- Double type switch all the way&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">thing</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">t</span> <span class="p">{</span>
	<span class="k">switch</span> <span class="nx">o</span> <span class="o">:=</span> <span class="nx">thing</span><span class="p">.(</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="o">*</span><span class="nx">A</span><span class="p">,</span> <span class="o">*</span><span class="nx">B</span><span class="p">:</span>
		<span class="k">switch</span> <span class="nx">oo</span> <span class="o">:=</span> <span class="nx">o</span><span class="p">.(</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="o">*</span><span class="nx">A</span><span class="p">:</span>
			<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">o</span><span class="p">),</span> <span class="s">&quot;is of type A or B. Name is:&quot;</span><span class="p">,</span> <span class="nx">oo</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
		<span class="k">case</span> <span class="o">*</span><span class="nx">B</span><span class="p">:</span>
			<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">o</span><span class="p">),</span> <span class="s">&quot;is of type A or B. Name is:&quot;</span><span class="p">,</span> <span class="nx">oo</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="o">*</span><span class="nx">C</span><span class="p">:</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">o</span><span class="p">),</span> <span class="s">&quot;is of type C. Name is:&quot;</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></div>
<h5>Results</h5>
<div class="highlight"><pre>--- Double type switch all the way
*main.A is of type A or B. Name is: A
*main.B is of type A or B. Name is: B
*main.C is of type C. Name is: C
</pre></div>
<p>&#8230;which looks a bit messy. A more straightforward way would be to
  flinch away our desire to make things &#8220;DRY&#8221;, still rely on the first type switch
  and just repeat more code:</p>
<div class="highlight"><pre><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;--- The Go Way™&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">thing</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">t</span> <span class="p">{</span>
	<span class="k">switch</span> <span class="nx">o</span> <span class="o">:=</span> <span class="nx">thing</span><span class="p">.(</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="o">*</span><span class="nx">A</span><span class="p">:</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">o</span><span class="p">),</span> <span class="s">&quot;is of type A or B. Name is:&quot;</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
	<span class="k">case</span> <span class="o">*</span><span class="nx">B</span><span class="p">:</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">o</span><span class="p">),</span> <span class="s">&quot;is of type A or B. Name is:&quot;</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
	<span class="k">case</span> <span class="o">*</span><span class="nx">C</span><span class="p">:</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">o</span><span class="p">),</span> <span class="s">&quot;is of type C. Name is:&quot;</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>&#8230;which results in:</p>
<pre class="example">
--- The Go Way™
*main.A is of type A or B. Name is: A
*main.B is of type A or B. Name is: B
*main.C is of type C. Name is: C
</pre>
<h3>Progress so far</h3>
<p>So which one of the approaches is better?</p>
<p>I would say that probably the one with the
  multiple case statements where the same line is repeated, since when
  we type switch and have a <code>case</code> statement with one more type,
  we end up once again with an <code>interface</code>, and we need yet another <code>type switch</code>
  for it that generates more code which more or less says the
  same thing, so it seems that it is about as DRY as it could get
  for now using only <code>type switch</code>.</p>
<p><a href="https://play.golang.org/p/PEsLe_ZRzE">Link to the Go playground with the example</a></p>
<p>To solve the grouping problem, there is something else that we can
  try besides only using the <code>type switch</code>, which is using <code>interface</code> types.</p>
<h3>Example #3</h3>
<p>Another alternative would be to use a <code>Nameable</code> interface when creating the slice.
  This means first having to declare something like this:</p>
<div class="highlight"><pre><span class="kd">type</span> <span class="nx">Nameable</span> <span class="kd">interface</span> <span class="p">{</span>
  <span class="nx">GetName</span><span class="p">()</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">BasicAttrs</span> <span class="kd">struct</span> <span class="p">{</span> 
  <span class="nx">Name</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="c1">// Code generation could help with this...</span>
<span class="kd">type</span> <span class="nx">A</span> <span class="kd">struct</span> <span class="p">{</span> <span class="nx">BasicAttrs</span> <span class="p">}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">o</span> <span class="o">*</span><span class="nx">A</span><span class="p">)</span> <span class="nx">GetName</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Name</span> <span class="p">}</span>

<span class="kd">type</span> <span class="nx">B</span> <span class="kd">struct</span> <span class="p">{</span> <span class="nx">BasicAttrs</span> <span class="p">}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">o</span> <span class="o">*</span><span class="nx">B</span><span class="p">)</span> <span class="nx">GetName</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Name</span> <span class="p">}</span>

<span class="kd">type</span> <span class="nx">C</span> <span class="kd">struct</span> <span class="p">{</span> <span class="nx">BasicAttrs</span> <span class="p">}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">o</span> <span class="o">*</span><span class="nx">C</span><span class="p">)</span> <span class="nx">GetName</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Name</span> <span class="p">}</span>
</pre></div>
<p>So that we can later on use it as follows:</p>
<div class="highlight"><pre><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>

	<span class="nx">a</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">A</span><span class="p">{</span><span class="nx">BasicAttrs</span><span class="p">:</span><span class="nx">BasicAttrs</span> <span class="p">{</span> <span class="nx">Name</span><span class="p">:</span> <span class="s">&quot;A&quot;</span> <span class="p">}}</span>
	<span class="nx">b</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">B</span><span class="p">{</span><span class="nx">BasicAttrs</span><span class="p">:</span><span class="nx">BasicAttrs</span> <span class="p">{</span> <span class="nx">Name</span><span class="p">:</span> <span class="s">&quot;B&quot;</span> <span class="p">}}</span>
	<span class="nx">c</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">C</span><span class="p">{</span><span class="nx">BasicAttrs</span><span class="p">:</span><span class="nx">BasicAttrs</span> <span class="p">{</span> <span class="nx">Name</span><span class="p">:</span> <span class="s">&quot;C&quot;</span> <span class="p">}}</span>

	<span class="nx">t</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">Nameable</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
	<span class="nx">t</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">a</span><span class="p">)</span>
	<span class="nx">t</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span>
	<span class="nx">t</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span>

	<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;--- The correct Go way?&quot;</span><span class="p">)</span>
	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">thing</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">t</span> <span class="p">{</span>
	<span class="k">switch</span> <span class="nx">o</span> <span class="o">:=</span> <span class="nx">thing</span><span class="p">.(</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span>
	   <span class="k">case</span> <span class="o">*</span><span class="nx">A</span><span class="p">,</span> <span class="o">*</span><span class="nx">B</span><span class="p">:</span>
	      <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">o</span><span class="p">),</span> <span class="s">&quot;is of type A or B. Name is:&quot;</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">GetName</span><span class="p">())</span>
	   <span class="k">case</span> <span class="o">*</span><span class="nx">C</span><span class="p">:</span>
	     <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">o</span><span class="p">),</span> <span class="s">&quot;is of type C. Name is:&quot;</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">GetName</span><span class="p">())</span>
	  <span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></div>
<h5>Results</h5>
<pre class="example">
--- The correct Go way?
*main.A is of type A or B. Name is: A
*main.B is of type A or B. Name is: B
*main.C is of type C. Name is: C
</pre>
<h3>Is this better?</h3>
<p>I think so.  Even though the implementation is a bit more verbose, the last example using a <code>type interface</code>
  might be the way to go in case we face the grouping issue from the raw interface.</p>



  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/posts/2014/12/12/using-tcpdump/">
        Quickly inspecting HTTP traffic with tcpdump
      </a>
    </h1>

    <span class="post-date">12 Dec 2014</span>

    
<p>Just a quick post on one of my favorite features of <code>tcpdump</code> that I
  have found useful for doing quick investigations of the behavior of an app
  and you need a little bit more than what you get with the access logs.</p>
<p>Wireshark has this <a href="http://www.wireshark.org/tools/string-cf.html">great site</a> that given a HTTP request,
  will give you a filter that if paired with the <code>-A</code> (print packet in ASCII) option from <code>tcpdump</code>
  will match all related HTTP traffic that is going on in a node.</p>
<p>A couple of basic examples:</p>
<ul>
  <li>Show all <code>GET</code> requests</li>
</ul>
<div class="highlight"><pre>tcpdump -A <span class="s1">&#39;tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):2] = 0x4745 &amp;&amp; tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2) + 2:1] = 0x54&#39;</span>

tcpdump: verbose output suppressed, use -v or -vv <span class="k">for </span>full protocol decode
listening on wlan0, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, capture size 65535 bytes
16:31:54.870479 IP 10.0.1.134.56724 &gt; 10.0.7.64.http-alt: Flags <span class="o">[</span>P.<span class="o">]</span>, seq 1988783165:1988783563, ack 2609786817, win 65535, options <span class="o">[</span>nop,nop,TS val 703013338 ecr 40647638<span class="o">]</span>, length 398
E...Bt@.@...
...
..@....v.l<span class="o">=</span>../............
<span class="o">)</span>.!..l<span class="p">;</span>.GET /v2/apps HTTP/1.1
Host: 10.0.77.64:8080
Connection: keep-alive
Accept: application/json, text/javascript, */*<span class="p">;</span> <span class="nv">q</span><span class="o">=</span>0.01
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 <span class="o">(</span>Macintosh<span class="p">;</span> Intel Mac OS X 10_7_5<span class="o">)</span> AppleWebKit/537.36 <span class="o">(</span>KHTML, like Gecko<span class="o">)</span> Chrome/39.0.2171.71 Safari/537.36
Referer: http://10.0.7.64:8080/
Accept-Encoding: gzip, deflate, sdch
Accept-Language: en-US,en<span class="p">;</span><span class="nv">q</span><span class="o">=</span>0.8
</pre></div>
<ul>
  <li>Show all <code>POST</code> requests</li>
</ul>
<div class="highlight"><pre>tcpdump -A <span class="s1">&#39;tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x504f5354&#39;</span>

tcpdump: verbose output suppressed, use -v or -vv <span class="k">for </span>full protocol decode
listening on wlan0, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, capture size 65535 bytes
16:41:59.925399 IP 10.0.1.134.56765 &gt; 10.0.7.64.http-alt: Flags <span class="o">[</span>P.<span class="o">]</span>, seq 1595944397:1595945056, ack 1073928153, win 65535, options <span class="o">[</span>nop,nop,TS val 703610055 ecr 40792556<span class="o">]</span>, length 659
E.....@.@.o.
...
..@...._ -.@..............
<span class="o">)</span>.&lt;..nq.POST /v2/apps HTTP/1.1
Host: 10.0.77.64:8080
Connection: keep-alive
Content-Length: 182
Accept: application/json, text/javascript, */*<span class="p">;</span> <span class="nv">q</span><span class="o">=</span>0.01
Origin: http://10.0.7.64:8080
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 <span class="o">(</span>Macintosh<span class="p">;</span> Intel Mac OS X 10_7_5<span class="o">)</span> AppleWebKit/537.36 <span class="o">(</span>KHTML, like Gecko<span class="o">)</span> Chrome/39.0.2171.71 Safari/537.36
Content-Type: application/json
Referer: http://10.0.7.64:8080/
Accept-Encoding: gzip, deflate
Accept-Language: en-US,en<span class="p">;</span><span class="nv">q</span><span class="o">=</span>0.8
</pre></div>
<p>You can add more info to the path (e.g. <code>GET /v2/</code>) to narrow down the actions
  that are being investigated.</p>



  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/posts/2014/12/12/using-org-babel-for-lp-jp/">
        Org Babelで文芸的プログラミング
      </a>
    </h1>

    <span class="post-date">12 Dec 2014</span>

    
<p>(This is a post for the <a href="http://qiita.com/advent-calendar/2014/emacs">Emacs Advent Calendar 2014</a> from Japan, a similar English version can be found <a href="http://literateinfrastructure.org/posts/2014/12/12/using-org-babel-for-lp/">here</a>)</p>
<p>Org modeの話を聞いたことがある方は、Org modeは「TODOリスト管理ツールの
  一つだ」と思われる方が多いかもしれません。それはその通りですが、
  Org Babelというモードで、「文芸的プログラミング(Literate Programming)」を実現することができます。</p>
<p>Org Babelの使い方を示すために、あるホストのモニタリング情報を表示する、
  単純なSinatraアプリケーションを例えにします。</p>
<h3>例: ホストのモニタリング情報を表示するSinatra app</h3>
<p>表示したい項目をシステムの <code>uptime</code> と ESTABLISHEDコネクションの数に絞り込みます。</p>
<div class="highlight"><pre>uptime

20:37  up 4 days,  9:48, 5 users, load averages: 0.67 0.86 1.11
</pre></div>
<p><code>ESTABLISHED</code> コネクションの数:</p>
<div class="highlight"><pre>netstat -an <span class="p">|</span> grep ESTABLISHED <span class="p">|</span> wc -l

       5
</pre></div>
<p>この二つのコマンドの結果を集めて、 HTTPクライアントを使えば
  <code>GET /vars</code> で取れるようになります：</p>
<div class="highlight"><pre>curl 127.0.0.1:9292/vars
</pre></div>
<h3>事前準備</h3>
<p>まず、ディレクトリの作成が必要です:</p>
<div class="highlight"><pre>mkdir -p org
mkdir -p src
touch readme.org
</pre></div>
<ul>
  <li><code>org/</code> ディレクトリの下に置くファイルはOrg mode で書きます</li>
  <li><code>src/</code> ディレクトリの下に置くファイルはSinatraアプリケーションのソースコード</li>
</ul>
<p>(<code>readme.org</code> の作成は必要ではないですが、best practiceとしておすすめします&#8230;)</p>
<p>最終的に、ディレクトリ構成はこんな感じになります:</p>
<div class="highlight"><pre>.
├── org
│   ├── app.org
│   └── run.org
├── readme.org
├── src
│   ├── Gemfile
│   ├── app.rb
│   └── config.ru
</pre></div>
<h3>実装</h3>
<p>アプリケーションの実装自体は <code>org/app.org</code> に書きます。</p>
<pre class="example">
touch org/app.org
</pre>
<h4>プロトタイプ</h4>
<p>SinatraのWebアプリケーションを実装前に、Org Babel を使ってプロトタイプを作りましょう。
  Rubyのcode blockを書いたら、 <code>C-c C-c</code> で実行することができます。</p>
<pre class="src src-org"><span style="color: #A6E22E;">*** Notes on how to get the results</span>

We could use something simple like:

<span style="color: #465457; font-style: italic;">#+begin_src ruby :results output code</span>
s = <span style="color: #E6DB74;">&lt;&lt;VARS</span>
<span style="color: #E6DB74;">Uptime:</span>
<span style="color: #F92672;">#{`uptime`}</span>

<span style="color: #E6DB74;">ESTABLISHED connections:</span>
<span style="color: #F92672;">#{`netstat -an | grep ESTABLISHED | wc -l`}</span>

<span style="color: #E6DB74;">VARS</span>

puts s
<span style="color: #465457; font-style: italic;">#+end_src</span>

<span style="color: #465457; font-style: italic;">#+RESULTS:</span>
<span style="color: #465457; font-style: italic;">#+BEGIN_SRC ruby</span>
<span style="color: #66D9EF;">Uptime</span>:
22<span style="color: #AE81FF;">:23</span>  up 4 days, 11<span style="color: #AE81FF;">:34</span>, 5 users, load averages: 0.58 0.46 0.30


<span style="color: #66D9EF;">ESTABLISHED</span> connections:
       8


<span style="color: #465457; font-style: italic;">#+END_SRC</span>
</pre>
<h4><code>:tangle</code> の使い方</h4>
<p><code>:tangle</code> はOrg modeのcode block switch argumentsの一つです。
  これを使えば、Org modeのcode blockは実装しているファイルを設定できます。</p>
<p>例えば、 <code>:tangle</code> を使って <code>Gemfile</code> と <code>config.ru</code> の内容を書きましょう。</p>
<div class="highlight"><pre>Dependencies from the app, just sinatra and webrick <span class="k">for </span>the server is ok <span class="k">for </span>now.

<span class="c">#+BEGIN_SRC ruby :tangle src/Gemfile</span>
gem <span class="s1">&#39;sinatra&#39;</span>
<span class="c">#+END_SRC</span>

Needed to start the Sinatra application:

<span class="c">#+BEGIN_SRC ruby :tangle src/config.ru</span>
require <span class="s1">&#39;./app.rb&#39;</span>
run Sinatra::Application
<span class="c">#+END_SRC</span>
</pre></div>
<h4><i>全体例</i></h4>
<p>EmacsのOrg modeバッファーで, <code>C-c C-v t</code> か <code>C-c C-v C-t</code> を叩けば、
  Org modeの <code>org-babel-tangle</code> の機能を呼び出します。
  これで、動かせるプログラムは <code>src/</code> ディレクトリの下に現れます。</p>
<pre class="src src-org"><span style="color: #b3b3b3;">#+TITLE:</span> <span style="color: #cafe12; font-size: 144%; font-weight: bold;">Monitoring HTTP endpoint</span>

  This is a simple Sinatra application that provides
  the following endpoints:

  &hyphen; <span style="color: #cafe12; font-weight: bold;">=/=</span><span style="font-weight: bold;">        ::</span> which responds <span style="color: #cafe12;">=OK=</span> in case all is good with the server.
  &hyphen; <span style="color: #cafe12; font-weight: bold;">=/vars=</span><span style="font-weight: bold;">    ::</span> to get info about the system

  <span style="color: #F92672;">** Bootstrapping the app</span>

  <span style="color: #A6E22E;">*** Gemfile</span>

  Dependencies from the app, just sinatra and webrick for now is ok.

  <span style="color: #465457; font-style: italic;">#+BEGIN_SRC ruby :tangle src/Gemfile</span>
  gem <span style="color: #E6DB74;">'sinatra'</span>
  <span style="color: #465457; font-style: italic;">#+END_SRC</span>

  <span style="color: #A6E22E;">*** Config.ru</span>

  Needed to start the sinatra application

  <span style="color: #465457; font-style: italic;">#+BEGIN_SRC ruby :tangle src/config.ru</span>
  require <span style="color: #E6DB74;">'./app.rb'</span>
  run <span style="color: #66D9EF;">Sinatra</span>::<span style="color: #66D9EF;">Application</span>
  <span style="color: #465457; font-style: italic;">#+END_SRC</span>

  <span style="color: #F92672;">** The App</span>

  <span style="color: #A6E22E;">*** Import dependencies</span>

  <span style="color: #465457; font-style: italic;">#+BEGIN_SRC ruby :tangle src/app.rb</span>

  require <span style="color: #E6DB74;">'sinatra'</span>

  <span style="color: #465457; font-style: italic;">#+END_SRC</span>

  <span style="color: #A6E22E;">*** </span><span style="color: #A6E22E;">=/=</span><span style="color: #A6E22E;"> endpoint</span>

  Just respond with <span style="color: #cafe12;">=OK=</span>.

  <span style="color: #465457; font-style: italic;">#+BEGIN_SRC ruby :tangle src/app.rb</span>
  get <span style="color: #E6DB74;">'/'</span> <span style="color: #66D9EF;">do</span>
  <span style="color: #E6DB74;">&nbsp;&nbsp;'OK'</span>
  <span style="color: #66D9EF;">end</span>
  <span style="color: #465457; font-style: italic;">#+END_SRC</span>

  <span style="color: #A6E22E;">*** </span><span style="color: #A6E22E;">=/vars=</span><span style="color: #A6E22E;"> endpoint</span>

  Respond with info about the system:

  <span style="color: #465457; font-style: italic;">#+BEGIN_SRC ruby :tangle src/app.rb</span>
  get <span style="color: #E6DB74;">'/vars'</span> <span style="color: #66D9EF;">do</span>

  r = <span style="color: #E6DB74;">&lt;&lt;VARS</span>
  <span style="color: #E6DB74;">Uptime:</span>
  <span style="color: #F92672;">#{`uptime`}</span>

  <span style="color: #E6DB74;">ESTABLISHED connections:</span>
  <span style="color: #F92672;">#{`netstat -an | grep ESTABLISHED | wc -l`}</span>

  <span style="color: #E6DB74;">VARS</span>

  r
  <span style="color: #66D9EF;">end</span>
  <span style="color: #465457; font-style: italic;">#+END_SRC</span>
</pre>

<h3>動かす方法</h3>
<p>次に、プログラムを動かす方法を <code>org/run.org</code> にまとめます。
  プログラムを動かす前に、Sinatraのプログラムに修正があったかも知れないので、
  <code>#+include: org/app.org</code> でこの依存関係を設定します。</p>
<pre class="src src-org"><span style="color: #b3b3b3;">#+TITLE:</span>   <span style="color: #cafe12; font-size: 144%; font-weight: bold;">Running the Application</span>
<span style="color: #465457; font-style: italic;">#+include: "org/app.org"</span>

<span style="color: #F92672;">** Run it</span>

To run it, we will need to get the dependencies first,
and then start it with bundler:

<span style="color: #465457; font-style: italic;">#+name: server</span>
<span style="color: #465457; font-style: italic;">#+BEGIN_SRC sh :dir src</span>
bundle install
bundle exec rackup
<span style="color: #465457; font-style: italic;">#+END_SRC</span>

Now let's send some requests to it:

<span style="color: #465457; font-style: italic;">#+name: curl</span>
<span style="color: #465457; font-style: italic;">#+BEGIN_SRC sh :wait 1</span>
<span style="color: #66D9EF;">while</span> true; <span style="color: #66D9EF;">do</span> 
  curl 127.0.0.1:9292/vars 2&gt; /dev/null
  sleep 1
<span style="color: #66D9EF;">done</span>
<span style="color: #465457; font-style: italic;">#+END_SRC</span>
</pre>
<p>Emacsでlong running processesを実行できますが、そうするとEmacsがコードブロック
  の結果待ちをしてしまいます&#8230; それを避けるため、
  コードブロックの上に、 <code>#+name</code> を設定すれば、私が作ったgemで叩くことができます:</p>
<pre class="example">
gem install org-converge
org-run org/run.org
</pre>
<p>そうすると結果は以下のようになります：</p>
<div class="highlight"><pre>org-run org/run.org
...
Running code blocks now! (2 runnable blocks found in total)
server    -- started with pid 71840
curl      -- started with pid 71841
server    -- Using rack 1.5.2
server    -- Using rack-protection 1.5.3
server    -- Using tilt 1.4.1
server    -- Using sinatra 1.4.5
server    -- Using bundler 1.7.1
server    -- Your bundle is complete!
server    -- Use `bundle show [gemname]` to see where a bundled gem is installed.
server    -- [2014-12-11 22:56:42] INFO  WEBrick 1.3.1
server    -- [2014-12-11 22:56:42] INFO  ruby 2.1.2 (2014-05-08) [x86_64-darwin11.0]
server    -- [2014-12-11 22:56:42] INFO  WEBrick::HTTPServer#start: pid=71848 port=9292
server    -- 127.0.0.1 - - [11/Dec/2014 22:56:42] &quot;GET /vars HTTP/1.1&quot; 200 110 0.0527
curl      -- Uptime:
curl      -- 22:56  up 4 days, 12:07, 5 users, load averages: 0.78 0.84 0.76
curl      -- 
curl      -- 
curl      -- ESTABLISHED connections:
curl      --       12
curl      -- 
curl      -- 
server    -- 127.0.0.1 - - [11/Dec/2014 22:56:43] &quot;GET /vars HTTP/1.1&quot; 200 110 0.0210
curl      -- Uptime:
curl      -- 22:56  up 4 days, 12:07, 5 users, load averages: 0.78 0.84 0.76
curl      -- 
curl      -- 
curl      -- ESTABLISHED connections:
curl      --       12
curl      -- 
curl      -- 
</pre></div>
<h3>まとめ</h3>
<p>Org modeはとても便利です！皆さんぜひお試しください。
  しかも、Githubさんが org-rubyを使って <code>.org</code> ファイルをHTMLに変換してくれるのです。
  Ruby の Org modeパーサはまだOrg mode のすべての機能に追いついていませんが、
  私がある程度メンテナンスしています。もしOrg Rubyに何かの問題があれば、
  こちらに <a href="https://github.com/wallyqs/org-ruby/issues">issue</a> を発行していただければと思います。 :)</p>
<p>(そして、日本語が間違っている場合、こちらに <a href="https://github.com/wallyqs/wallyqs.github.io/tree/source/org/posts">PR</a> ください&#8230;)</p>



  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/posts/2014/12/12/using-org-babel-for-lp/">
        Using Org Babel for Literate Programming
      </a>
    </h1>

    <span class="post-date">12 Dec 2014</span>

    
<p>Most people that have heard about Org mode are aware that
  it is a tool meant for creating <code>TODO</code> lists, taking notes,
  and even doing documentation to some extent.</p>
<p>What is not immediately clear about Org mode is that it is a very
  powerful tool for doing literate programming and a comfortable
  environment for working with active documents.</p>
<p>Rather than explain the ideas one by one, I will give a more
  practical example of what it is possible to do with it.</p>
<h3>Example: Creating a monitoring HTTP endpoint</h3>
<p>Let&#8217;s create a simple HTTP endpoint with Sinatra which
  will respond with some information about the host where it is running,
  like its <code>uptime</code> and the number of established connections.</p>
<h4>Requirements</h4>
<p>What we want is basically the output of the following commands:</p>
<div class="highlight"><pre>uptime
</pre></div>
<p>&#8230;which will show something like this:</p>
<div class="highlight"><pre>20:37  up 4 days,  9:48, 5 users, load averages: 0.67 0.86 1.11
</pre></div>
<p>And:</p>
<div class="highlight"><pre>netstat -an <span class="p">|</span> grep ESTABLISHED <span class="p">|</span> wc -l
</pre></div>
<p>which shows a number:</p>
<div class="highlight"><pre>5
</pre></div>
<p>The result from both commands would be aggregated into
  the response sent by the the server when we request <code>/vars</code>:</p>
<div class="highlight"><pre>curl 127.0.0.1:9292/vars
</pre></div>
<p>Result:</p>
<pre class="example">
Uptime:

20:37  up 4 days,  9:48, 5 users, load averages: 0.67 0.86 1.11

ESTABLISHED connections: 14

</pre>
<h3>Preparation</h3>
<p>We will start by creating a couple of folders, one for the content
  we write in Org, and another one for the actual implementation.</p>
<div class="highlight"><pre>mkdir -p org
mkdir -p src
touch readme.org
</pre></div>
<p>(The <code>readme.org</code> file is of course optional, but still a good practice to follow.)</p>
<p>In the end, our directory structure will look something like this:</p>
<div class="highlight"><pre>.
├── org
│   ├── app.org
│   └── run.org
├── readme.org
├── src
│   ├── Gemfile
│   ├── app.rb
│   └── config.ru
</pre></div>
<h3>Implementation</h3>
<p>Most of the contents of our application, we will develop within an
  <code>org/app.org</code> file.</p>
<pre class="example">
touch org/app.org
</pre>
<h4>Prototyping phase</h4>
<p>Usually, while developing a program we go into a <code>REPL</code> to test out what
  would eventually make it into the program.</p>
<p>With <b>Org Babel</b> though, it is possible to call the code blocks within
  an Emacs buffer, so we can actually start prototyping using Org mode.
  Each time we press <code>C-c C-c</code> on top of the code block, the results
  would be refreshed:</p>
<pre class="src src-org"><span style="color: #A6E22E;">*** Notes on how to get the results</span>

We could use something simple like:

<span style="color: #465457; font-style: italic;">#+begin_src ruby :results output code</span>
s = <span style="color: #E6DB74;">&lt;&lt;VARS</span>
<span style="color: #E6DB74;">Uptime:</span>
<span style="color: #F92672;">#{`uptime`}</span>

<span style="color: #E6DB74;">ESTABLISHED connections:</span>
<span style="color: #F92672;">#{`netstat -an | grep ESTABLISHED | wc -l`}</span>

<span style="color: #E6DB74;">VARS</span>

puts s
<span style="color: #465457; font-style: italic;">#+end_src</span>

<span style="color: #465457; font-style: italic;">#+RESULTS:</span>
<span style="color: #465457; font-style: italic;">#+BEGIN_SRC ruby</span>
<span style="color: #66D9EF;">Uptime</span>:
22<span style="color: #AE81FF;">:23</span>  up 4 days, 11<span style="color: #AE81FF;">:34</span>, 5 users, load averages: 0.58 0.46 0.30


<span style="color: #66D9EF;">ESTABLISHED</span> connections:
       8


<span style="color: #465457; font-style: italic;">#+END_SRC</span>
</pre>
<h4>Using <code>:tangle</code> to create the files of the program</h4>
<p>We can have a code block be <i>tangled</i> into a file by using the
  <code>:tangle</code> switch argument.  For example, we can define the <code>Gemfile</code>
  and <code>config.ru</code> files within an Org mode buffer like this:</p>
<div class="highlight"><pre>Dependencies from the app, just sinatra and webrick <span class="k">for </span>the server is ok <span class="k">for </span>now.

<span class="c">#+BEGIN_SRC ruby :tangle src/Gemfile</span>
gem <span class="s1">&#39;sinatra&#39;</span>
<span class="c">#+END_SRC</span>

Needed to start the Sinatra application:

<span class="c">#+BEGIN_SRC ruby :tangle src/config.ru</span>
require <span class="s1">&#39;./app.rb&#39;</span>
run Sinatra::Application
<span class="c">#+END_SRC</span>
</pre></div>
<h4>Full example</h4>
<p>The Sinatra application would then look something like this.
  From Emacs, we can either press <code>C-c C-v t</code> or <code>C-c C-v C-t</code>,
  (<code>M-x org-babel-tangle</code> also does it) to tangle the web of
  code blocks to their respective files.</p>
<pre class="src src-org"><span style="color: #b3b3b3;">#+TITLE:</span> <span style="color: #cafe12; font-size: 144%; font-weight: bold;">Monitoring HTTP endpoint</span>

  This is a simple Sinatra application that provides
  the following endpoints:

  &hyphen; <span style="color: #cafe12; font-weight: bold;">=/=</span><span style="font-weight: bold;">        ::</span> which responds <span style="color: #cafe12;">=OK=</span> in case all is good with the server.
  &hyphen; <span style="color: #cafe12; font-weight: bold;">=/vars=</span><span style="font-weight: bold;">    ::</span> to get info about the system

  <span style="color: #F92672;">** Bootstrapping the app</span>

  <span style="color: #A6E22E;">*** Gemfile</span>

  Dependencies from the app, just sinatra and webrick for now is ok.

  <span style="color: #465457; font-style: italic;">#+BEGIN_SRC ruby :tangle src/Gemfile</span>
  gem <span style="color: #E6DB74;">'sinatra'</span>
  <span style="color: #465457; font-style: italic;">#+END_SRC</span>

  <span style="color: #A6E22E;">*** Config.ru</span>

  Needed to start the sinatra application

  <span style="color: #465457; font-style: italic;">#+BEGIN_SRC ruby :tangle src/config.ru</span>
  require <span style="color: #E6DB74;">'./app.rb'</span>
  run <span style="color: #66D9EF;">Sinatra</span>::<span style="color: #66D9EF;">Application</span>
  <span style="color: #465457; font-style: italic;">#+END_SRC</span>

  <span style="color: #F92672;">** The App</span>

  <span style="color: #A6E22E;">*** Import dependencies</span>

  <span style="color: #465457; font-style: italic;">#+BEGIN_SRC ruby :tangle src/app.rb</span>

  require <span style="color: #E6DB74;">'sinatra'</span>

  <span style="color: #465457; font-style: italic;">#+END_SRC</span>

  <span style="color: #A6E22E;">*** </span><span style="color: #A6E22E;">=/=</span><span style="color: #A6E22E;"> endpoint</span>

  Just respond with <span style="color: #cafe12;">=OK=</span>.

  <span style="color: #465457; font-style: italic;">#+BEGIN_SRC ruby :tangle src/app.rb</span>
  get <span style="color: #E6DB74;">'/'</span> <span style="color: #66D9EF;">do</span>
  <span style="color: #E6DB74;">&nbsp;&nbsp;'OK'</span>
  <span style="color: #66D9EF;">end</span>
  <span style="color: #465457; font-style: italic;">#+END_SRC</span>

  <span style="color: #A6E22E;">*** </span><span style="color: #A6E22E;">=/vars=</span><span style="color: #A6E22E;"> endpoint</span>

  Respond with info about the system:

  <span style="color: #465457; font-style: italic;">#+BEGIN_SRC ruby :tangle src/app.rb</span>
  get <span style="color: #E6DB74;">'/vars'</span> <span style="color: #66D9EF;">do</span>

  r = <span style="color: #E6DB74;">&lt;&lt;VARS</span>
  <span style="color: #E6DB74;">Uptime:</span>
  <span style="color: #F92672;">#{`uptime`}</span>

  <span style="color: #E6DB74;">ESTABLISHED connections:</span>
  <span style="color: #F92672;">#{`netstat -an | grep ESTABLISHED | wc -l`}</span>

  <span style="color: #E6DB74;">VARS</span>

  r
  <span style="color: #66D9EF;">end</span>
  <span style="color: #465457; font-style: italic;">#+END_SRC</span>
</pre>

<h3>Running it</h3>
<p>Now that, we have defined the program, it would be also helpful to
  define how to actually run it.  We will write this in a <code>org/run.org</code>
  file.
  Note how we are including the <code>org/app.org</code> application as a
  dependency so that in case of changes those code blocks become tangled
  as well.</p>
<pre class="src src-org"><span style="color: #b3b3b3;">#+TITLE:</span>   <span style="color: #cafe12; font-size: 144%; font-weight: bold;">Running the Application</span>
<span style="color: #465457; font-style: italic;">#+include: "org/app.org"</span>

<span style="color: #F92672;">** Run it</span>

To run it, we will need to get the dependencies first,
and then start it with bundler:

<span style="color: #465457; font-style: italic;">#+name: server</span>
<span style="color: #465457; font-style: italic;">#+BEGIN_SRC sh :dir src</span>
bundle install
bundle exec rackup
<span style="color: #465457; font-style: italic;">#+END_SRC</span>

Now let's send some requests to it:

<span style="color: #465457; font-style: italic;">#+name: curl</span>
<span style="color: #465457; font-style: italic;">#+BEGIN_SRC sh :wait 1</span>
<span style="color: #66D9EF;">while</span> true; <span style="color: #66D9EF;">do</span> 
  curl 127.0.0.1:9292/vars 2&gt; /dev/null
  sleep 1
<span style="color: #66D9EF;">done</span>
<span style="color: #465457; font-style: italic;">#+END_SRC</span>
</pre>
<p>Here we are giving the code block a <code>#+name:</code>, doing this make it
  possible to reuse the code block later on.  I made a small gem that
  makes it possible to run these kind of blocks when they have a name.</p>
<pre class="example">
gem install org-converge
org-run org/run.org
</pre>
<p>The output would look like this:</p>
<div class="highlight"><pre>org-run org/run.org
...
Running code blocks now! (2 runnable blocks found in total)
server    -- started with pid 71840
curl      -- started with pid 71841
server    -- Using rack 1.5.2
server    -- Using rack-protection 1.5.3
server    -- Using tilt 1.4.1
server    -- Using sinatra 1.4.5
server    -- Using bundler 1.7.1
server    -- Your bundle is complete!
server    -- Use `bundle show [gemname]` to see where a bundled gem is installed.
server    -- [2014-12-11 22:56:42] INFO  WEBrick 1.3.1
server    -- [2014-12-11 22:56:42] INFO  ruby 2.1.2 (2014-05-08) [x86_64-darwin11.0]
server    -- [2014-12-11 22:56:42] INFO  WEBrick::HTTPServer#start: pid=71848 port=9292
server    -- 127.0.0.1 - - [11/Dec/2014 22:56:42] &quot;GET /vars HTTP/1.1&quot; 200 110 0.0527
curl      -- Uptime:
curl      -- 22:56  up 4 days, 12:07, 5 users, load averages: 0.78 0.84 0.76
curl      -- 
curl      -- 
curl      -- ESTABLISHED connections:
curl      --       12
curl      -- 
curl      -- 
server    -- 127.0.0.1 - - [11/Dec/2014 22:56:43] &quot;GET /vars HTTP/1.1&quot; 200 110 0.0210
curl      -- Uptime:
curl      -- 22:56  up 4 days, 12:07, 5 users, load averages: 0.78 0.84 0.76
curl      -- 
curl      -- 
curl      -- ESTABLISHED connections:
curl      --       12
curl      -- 
curl      -- 
</pre></div>
<h3>Final remarks</h3>
<p>I think there is a lot of potential in the approach from Org mode
  for Literate Programming, so it is worth a try.
  Take a look at the concepts exposed by Knuth in his <a href="http://www.literateprogramming.com/knuthweb.pdf">paper</a> on the
  matter, and you will find out that the core ideas about LP have not
  shown its age.</p>
<p>These days, most of my development starts from an Org mode buffer
  and it just continues there.  With Org mode, you can basically start with a Readme
  (c.f. <i>Readme Driven Development</i>), and then just contine doing the
  full implementation of your source there in the same place, along with
  your notes (but which are not exported).</p>
<p>At the same time, it makes up for very useful documentation for others
  to pick up a project later on.
  And also Org mode file rendering is supported by Github!  In case of bugs,
  please send me a <a href="https://github.com/wallyqs/org-ruby">ticket here</a>.</p>



  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/posts/2014/12/08/eternal-recurrence-of-paas/">
        The Eternal Recurrence of PaaS
      </a>
    </h1>

    <span class="post-date">08 Dec 2014</span>

    
<p>Distributed Systems are hard.</p>
<p>As a service grows popular, there inevitably comes the time that capability to <b>scale</b> is demanded from
  a system, and while doing so it is required that the system has <b>uptime</b>.
  As we go on tackling such issues, it results that we end up with a
  distributed system that becomes increasingly complex and its
  understanding requires an ongoing online computation of its state.</p>
<p>Under such a system, failures are a constant, and whether this failure
  ends up in tragedy or not, depends on how well the platform developer
  was prepared for such events.</p>
<div style="text-align: center">
  <p><img src="/public/cat-theorem.png" alt="/public/cat-theorem.png" /></p>
  <p><b>Fig. 1.</b> <i>The CAT theorem</i> (coined by <a href="http://www.schwertly.com/">Stan</a>)</p>
</div>
<p>Then, what if while at handling this complexity, or a tragic event that ends up in firefighting,
  (<i>in your loneliest loneliness</i> as Nietzche puts it),
  a demon came up to you and reveal that it doesn&#8217;t
  get any better? That <a href="http://queue.acm.org/detail.cfm?id=2482856">there is no way around it</a>,
  and &#8221;<i>this life which you live must be lived by you once again and innumerable times more; and every pain and joy and thought and sigh must come again to you, all in the same sequence</i>&#8221;.</p>
<p>Nietzche poses as the outcome of this thought experiment
  one out of two possible choices: the individual either accepts it and becomes stronger
  from the cognitive process triggered as a result of the tragedy (<i><a href="http://en.wikipedia.org/wiki/Amor_fati">amor fati</a></i>),
  or the individual succumbs to what he calls <i><a href="http://en.wikipedia.org/wiki/Ressentiment">Ressentiment</a></i>.</p>
<p>The platform developer, by attempting to build and operate a
  distributed system, will continuously be exposed to a set of challenges
  that will end up with having to face this test of character.</p>
<p>Such as in life (which is itself some sort of distributed system too),
  in a distributed system, tragedy is a constant.  The <a href="http://en.wikipedia.org/wiki/CAP_theorem">CAP theorem</a> &amp; <a href="http://en.wikipedia.org/wiki/Consensus_%28computer_science%29#Solvability_results_for_some_agreement_problems">FPL result</a>,
  are just a couple of examples which show the constant tragedy that comes
  along with operating distributed systems.</p>
<p>For the platform developer that does not succumb to ressentiment, what
  lies ahead is easy to predict: it will reflect on the tragedy and use
  the literature to improve the situation and in the end, succeed like
  others have before in taming a system with many moving parts without
  shying away from the difficult problems.  Tackling and understanding the
  tradeoffs around fault tolerance, high availability, distributed
  agreement, etc&#8230; all lead to a living a good life for the platform
  developer.</p>
<p>But what about the platform developer that succumbs to <i>ressentiment</i>?</p>
<p>Like the quote from Tolstoy goes:</p>
<blockquote>
  <p>All happy families are alike; each unhappy family is unhappy in its own way.</p>
</blockquote>
<p>In my experience (and under my line of reasoning stated in the previous
  paragraphs), when such thing happens it could be possible to see some
  of the following behaviors below for example:</p>
<h6>Cynism, Skepticism</h6>
<p>We can avoid having to scale by keeping services small.
  Instead of having shared infrastructure we could make everyone in the company run
  a similar version of the same, then <i>they</i> have to take care of
  running it.  There is no need to have a platform even if we have
  hundreds of nodes.</p>
<p>This platform developer has experienced the pains of having to operate
  a distributed system.  Microservices <a href="http://martinfowler.com/bliki/MicroservicePrerequisites.html">are</a> <a href="http://highscalability.com/blog/2014/4/8/microservices-not-a-free-lunch.html">hard</a>, and maybe unnecessary if
  complying to enough trade offs. It is ok to be uncompetitive in
  terms of platform related efforts and just keeping it simple.</p>
<p>The platform developer keeps the level of automation such that there
  is heavy partitioning and waste in the data center and tries to delegate
  difficult issues to avoid tragedies around operating a complex system.</p>
<h6>The sysadmin as practitioner of a slave morality</h6>
<p>A developer either aware or unaware of the challenges of having to run
  a distributed system may try to shield himself/herself of the issue.</p>
<p>As a result of the lack of empathy by the developer,
  a platform developer may develop <i>ressentiment</i> towards the opressors,
  that is the developers who lack empathy to the problem of tackling
  scalability issues.</p>
<h6>&#8220;Hell is other developers&#8221;</h6>
<p><i>Ressentiment</i> is to those that do not understand the situation in the
  the data center, and to those heavy users who are causing the architecture
  continue to grow.</p>
<p>The problem is not the platform, but the architecture of the application.
  Had the application architechture been designed properly there wouldn&#8217;t be a need to have as many servers.</p>
<p>Or there could be <i>ressentiment</i> as well to those users who for analytics purposes capture everything and produce lots of data.
  In case it is for auditing purposes, <i>ressentiment</i> then is towards those who audit.</p>
<p>The platform developer becomes more used to externalize issues that
  could be fixed in the platform on the users rather than fixing them.</p>
<h5>Conclusion</h5>
<p>It is my believe then that, compared to other areas of software
  development, there is a <i>Tragic Sense of Life</i> which
  has to be acknowledged earlier on when faced with operating
  a distributed system running in production, that is if one is set to the task of doing it correctly.</p>
<p>It is also my believe that even after much tragedy, a platform developer
  with ressentiment still has chance to overcome it and attempt to
  tackle the core issues of building a distributed system.
  It takes start asking &#8220;Why?&#8221; and then proceed to start reading papers,
  looking for someone else that has posed the same question
  (many times these fundamental questions already have been answered <a href="http://web.stanford.edu/class/cs240/readings/lamport.pdf">decades ago</a>&#8230;)</p>
<h5>Links</h5>
<p>Some links that have helped me out learning about distributed systems:</p>
<dl>
  <dt>Distributed Systems for fun and profit</dt><dd>
    I have found this book very useful to immerse in the basics of
    working with distributed systems.
    <a href="http://book.mixu.net/distsys/">http://book.mixu.net/distsys/</a></dd>
  <dt><i>Distributed Systems Archaeology</i> talk by Michael Bernstein</dt><dd>
    Another great talk by a man with an obsession which I can&#8217;t
    recommend enough.
    <a href="http://michaelrbernste.in/2013/11/22/distributed-systems-archaeology.html">http://michaelrbernste.in/2013/11/22/distributed-systems-archaeology.html</a></dd>
  <dt>Papers we love</dt><dd>
    There are many great distributed systems related videos of the meetups available
    <a href="http://paperswelove.org/">http://paperswelove.org/</a></dd>
  <dt>A Brief Tour of FLP Impossibility</dt><dd>
    TL;DR;
    &#8220;it’s not possible to say whether a processor has crashed or is simply taking a long time to respond.&#8221;
    <a href="http://the-paper-trail.org/blog/a-brief-tour-of-flp-impossibility/">http://the-paper-trail.org/blog/a-brief-tour-of-flp-impossibility/</a></dd>
  <dt>The CAP Theorem</dt><dd>
    Paper itself can be found at Papers we love <a href="https://github.com/papers-we-love/papers-we-love/blob/master/distributed_systems/brewers-conjecture.pdf">repo</a>. But
    the Distributed Systems for fun and profit book covers it in the
    <a href="http://book.mixu.net/distsys/abstractions.html">chapter 2</a> as well.</dd>
  <dt>Distributed systems theory for the distributed systems engineer</dt><dd>
    Great compilation of links
    <a href="http://the-paper-trail.org/blog/distributed-systems-theory-for-the-distributed-systems-engineer/">http://the-paper-trail.org/blog/distributed-systems-theory-for-the-distributed-systems-engineer/</a></dd>
</dl>



  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page2">Older</a>
  
  
    <span class="pagination-item newer">Newer</span>
  
</div>
    </div>

  </body>
</html>
