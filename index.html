<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Literate Infrastructure &middot; PaaS + Org mode
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-55629836-1', 'auto');
    ga('send', 'pageview');

  </script>
    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h2>
        <a href="/">
          Literate Infrastructure
        </a>
      </h2>
      <p>PaaS + Org mode</p>
      <p class="lead"><a href="https://twitter.com/wallyqs" target="_blank">@wallyqs</a></p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item active" href="/">Home</a>

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about.html">About</a>
          
        
      
        
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/posts/">Posts</a>
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      

    </nav>

    <p>&copy; 2015. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/posts/2015/03/31/variations-code-blocks-execution/">
        Variations around the execution of code blocks
      </a>
    </h1>

    <span class="post-date">31 Mar 2015</span>

    
<p>The following is an enumeration of the approach taken
  by systems or tools which in the end result in the execution of a code block
  by means of some configuration format, dsl, http request, cli tool, etc&#8230;</p>
<p>I decided to narrow down the list to the following for now:</p>
<ul>
  <li>Configuration management tools
    <dl>
      <dt>Chef</dt><dd>Configuration management tool</dd>
      <dt>Puppet</dt><dd>Configuration management tool</dd>
      <dt>Cloud Init</dt><dd>For configuration too..</dd>
    </dl>
  </li>
  <li>Infrastructure
    <dl>
      <dt>Packer</dt><dd>&#8220;Packer is a tool for creating identical machine images for multiple platforms from a single source configuration&#8221;</dd>
      <dt>Terraform</dt><dd>Tool from Hashicorp to have reproducible infrastructure setups</dd>
    </dl>
  </li>
  <li>Workloads scheduling
    <dl>
      <dt>Kubernetes</dt><dd>The container orchestration system from Google based on what they have learned around that area</dd>
      <dt>Marathon</dt><dd>Mesos framework for schedule long running jobs</dd>
    </dl>
  </li>
</ul>
<h1>Configuration</h1>
<h2>Chef</h2>
<ul>
  <li>Docs:
    <ul>
      <li><a href="https://docs.chef.io/resource_execute.html">https://docs.chef.io/resource_execute.html</a></li>
      <li><a href="https://docs.chef.io/resource_bash.html">https://docs.chef.io/resource_bash.html</a></li>
    </ul>
  </li>
</ul>
<p>Chef has some <i>resources</i> which help in the execution of code blocks.
  The configuration is driven by Ruby, which allows to not only having to rely</p>
<p>The following is based on the example found <a href="https://docs.chef.io/resource_execute.html">here</a>.  We have 2 code blocks
  in this case.  The first one creates a change in the server and the second one
  checks whether that code block has been executed in the past already,
  in order to make the resource <i>idempotent</i>.</p>
<div class="highlight"><pre><span class="sx">%w{rover fido bubbers}</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">pet_name</span><span class="o">|</span>
  <span class="n">execute</span> <span class="s2">&quot;feed_pet_</span><span class="si">#{</span><span class="n">pet_name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">do</span>
    <span class="n">command</span> <span class="s2">&quot;echo &#39;Feeding: </span><span class="si">#{</span><span class="n">pet_name</span><span class="si">}</span><span class="s2">&#39;; touch &#39;/tmp/</span><span class="si">#{</span><span class="n">pet_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
    <span class="c1"># not_if { ::File.exists?(&quot;/tmp/#{pet_name}&quot;)}</span>
    <span class="n">not_if</span> <span class="s2">&quot;cat /tmp/</span><span class="si">#{</span><span class="n">pet_name</span><span class="si">}</span><span class="s2"> | grep Feeding&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
<h2>Puppet</h2>
<ul>
  <li>Docs:
    <ul>
      <li><a href="https://docs.puppetlabs.com/references/latest/type.html#exec">https://docs.puppetlabs.com/references/latest/type.html#exec</a></li>
    </ul>
  </li>
</ul>
<p>Puppet also tries to achieve idempotent runs of the code blocks.
  According to the docs:</p>
<blockquote>
  <p>There are three main ways for an exec to be idempotent:</p>
  <p>The command itself is already idempotent. (For example, <code>apt-get update</code>.)
    The exec has an <code>onlyif</code>, <code>unless</code>, or <code>creates attribute</code>, which prevents Puppet from running the command unless some condition is met.
    The exec has <code>refreshonly =&gt; true</code>, which only allows Puppet to run the command when some other resource is changed.</p>
</blockquote>
<p>Here the execution is driven via a specialized DSL (though Ruby inspired?)
  in order to make things declarative.</p>
<p>An example of its usage:</p>
<div class="highlight"><pre><span class="vg">$my_file_arg</span> <span class="o">=</span> <span class="s1">&#39;/tmp/myarg.txt&#39;</span>

<span class="n">file</span> <span class="p">{</span> <span class="vg">$my_file_arg</span><span class="p">:</span>
  <span class="n">content</span> <span class="o">=&gt;</span> <span class="s2">&quot;Hello now&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="nb">exec</span> <span class="p">{</span><span class="s2">&quot;Use $my_file_arg&quot;</span><span class="p">:</span>
  <span class="nb">require</span> <span class="o">=&gt;</span> <span class="no">File</span><span class="o">[</span><span class="vg">$my_file_arg</span><span class="o">]</span><span class="p">,</span>
  <span class="n">command</span> <span class="o">=&gt;</span> <span class="s2">&quot;/bin/sed -i s/Hello/Bye/g $my_file_arg&quot;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
<p>Here we have 2 types of code blocks:</p>
<ul>
  <li>One expressing the contents of a file</li>
  <li>Another expressing the execution of a sed command</li>
</ul>
<h1>Infrastructure</h1>
<h2>Cloud config and Cloud Init</h2>
<ul>
  <li>Docs:
    <ul>
      <li><a href="http://cloudinit.readthedocs.org/en/latest/topics/format.html#cloud-config-data">http://cloudinit.readthedocs.org/en/latest/topics/format.html#cloud-config-data</a></li>
      <li><a href="https://coreos.com/docs/cluster-management/setup/cloudinit-cloud-config/">https://coreos.com/docs/cluster-management/setup/cloudinit-cloud-config/</a></li>
      <li><a href="http://cloudinit.readthedocs.org/en/latest/topics/examples.html#yaml-examples">http://cloudinit.readthedocs.org/en/latest/topics/examples.html#yaml-examples</a></li>
    </ul>
  </li>
</ul>
<p>Cloud config is an interesting case.  Its execution is leveraged via <i>Convention Over Configuration</i> approach
  where anything under a certain path will be executed on the node.</p>
<p>The execution in this case is driven by <code>YAML</code> as in Kubernetes.</p>
<p>Here is an example of using <code>runcmd</code> (example taken from <a href="http://cloudinit.readthedocs.org/en/latest/topics/examples.html#yaml-examples">here</a>)</p>
<div class="highlight"><pre><span class="c1">#cloud-config</span>

<span class="c1"># run commands</span>
<span class="c1"># default: none</span>
<span class="c1"># runcmd contains a list of either lists or a string</span>
<span class="c1"># each item will be executed in order at rc.local like level with</span>
<span class="c1"># output to the console</span>
<span class="c1"># - if the item is a list, the items will be properly executed as if</span>
<span class="c1">#   passed to execve(3) (with the first arg as the command).</span>
<span class="c1"># - if the item is a string, it will be simply written to the file and</span>
<span class="c1">#   will be interpreted by &#39;sh&#39;</span>
<span class="c1">#</span>
<span class="c1"># Note, that the list has to be proper yaml, so you have to escape</span>
<span class="c1"># any characters yaml would eat (&#39;:&#39; can be problematic)</span>
<span class="l-Scalar-Plain">runcmd</span><span class="p-Indicator">:</span>
 <span class="p-Indicator">-</span> <span class="p-Indicator">[</span> <span class="nv">ls</span><span class="p-Indicator">,</span> <span class="nv">-l</span><span class="p-Indicator">,</span> <span class="nv">/</span> <span class="p-Indicator">]</span>
 <span class="p-Indicator">-</span> <span class="p-Indicator">[</span> <span class="nv">sh</span><span class="p-Indicator">,</span> <span class="nv">-xc</span><span class="p-Indicator">,</span> <span class="s">&quot;echo</span><span class="nv"> </span><span class="s">$(date)</span><span class="nv"> </span><span class="s">&#39;:</span><span class="nv"> </span><span class="s">hello</span><span class="nv"> </span><span class="s">world!&#39;&quot;</span> <span class="p-Indicator">]</span>
 <span class="p-Indicator">-</span> <span class="p-Indicator">[</span> <span class="nv">sh</span><span class="p-Indicator">,</span> <span class="nv">-c</span><span class="p-Indicator">,</span> <span class="nv">echo &quot;=========hello world&#39;=========&quot;</span> <span class="p-Indicator">]</span>
 <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ls -l /root</span>
 <span class="p-Indicator">-</span> <span class="p-Indicator">[</span> <span class="nv">wget</span><span class="p-Indicator">,</span> <span class="s">&quot;http://slashdot.org&quot;</span><span class="p-Indicator">,</span> <span class="nv">-O</span><span class="p-Indicator">,</span> <span class="nv">/tmp/index.html</span> <span class="p-Indicator">]</span>
</pre></div>
<h2>Packer</h2>
<ul>
  <li>Documentation:
    <ul>
      <li><a href="https://www.packer.io/docs/command-line/build.html">https://www.packer.io/docs/command-line/build.html</a></li>
      <li><a href="https://www.packer.io/docs/provisioners/shell.html">https://www.packer.io/docs/provisioners/shell.html</a></li>
    </ul>
  </li>
</ul>
<p>Packer counts with a <code>shell provisioner</code>. A <i>provisioner</i> is a common theme in the tooling from Hashicorp.
  The description from the website notes:</p>
<blockquote>
  <p>The shell Packer provisioner provisions machines built by Packer using
    shell scripts. Shell provisioning is the easiest way to get software
    installed and configured on a machine.</p>
</blockquote>
<p>As an example, we can have <code>JSON</code> express what we want to do with the execution of the code block</p>
<div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span>
  <span class="s2">&quot;inline&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;echo foo&quot;</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
<p>The execution of the remote resource then, is driven by the <code>JSON</code> format.
  Here is a more <a href="http://blog.endpoint.com/2014/03/provisioning-development-environment_14.html">complex example</a> I could find, one that invokes <code>Ansible</code>.</p>
<div class="highlight"><pre><span class="s2">&quot;provisioners&quot;</span><span class="o">:</span> <span class="p">[</span>
  <span class="p">{</span>
    <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span>
    <span class="s2">&quot;inline&quot;</span><span class="o">:</span> <span class="p">[</span>
      <span class="s2">&quot;mkdir .ssh&quot;</span><span class="p">,</span>
      <span class="s2">&quot;echo &#39;{{user `public_key`}}&#39; &gt;&gt; .ssh/authorized_keys&quot;</span>
    <span class="p">]</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span>
    <span class="s2">&quot;execute_command&quot;</span><span class="o">:</span> <span class="s2">&quot;echo &#39;{{user `ssh_pass`}}&#39; | {{ .Vars }} sudo -E -S sh &#39;{{ .Path }}&#39;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;inline&quot;</span><span class="o">:</span> <span class="p">[</span>
      <span class="s2">&quot;add-apt-repository ppa:rquillo/ansible&quot;</span><span class="p">,</span>
      <span class="s2">&quot;apt-get update&quot;</span><span class="p">,</span>
      <span class="s2">&quot;apt-get install -y ansible&quot;</span><span class="p">,</span>
      <span class="s2">&quot;echo &#39;%sudo    ALL=(ALL)  NOPASSWD:ALL&#39; &gt;&gt; /etc/sudoers&quot;</span>
    <span class="p">]</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;ansible-local&quot;</span><span class="p">,</span>
    <span class="s2">&quot;playbook_file&quot;</span><span class="o">:</span> <span class="s2">&quot;site.yml&quot;</span>
  <span class="p">}</span>
<span class="p">]</span>
</pre></div>
<p>Here the provisioners are chained sequentially.
  One notable example is that we are now defining another sub code block named <code>execute_command</code>
  which is prepended to the execution of the original code block.</p>
<blockquote>
  <p>To many new users, the execute_command is puzzling. However, it provides an important function: customization of how the command is executed. The most common use case for this is dealing with sudo password prompts.</p>
</blockquote>
<h2>Terraform</h2>
<ul>
  <li>Docs:
    <ul>
      <li><a href="https://www.terraform.io/docs/provisioners/remote-exec.html">https://www.terraform.io/docs/provisioners/remote-exec.html</a></li>
    </ul>
  </li>
</ul>
<p>Terraform is an interesting case since it recognizes the limitations
  of using JSON and YAML to drive the execution of a provisioning run.</p>
<p>The following is an example of applying pupper, also taken from the docs.</p>
<div class="highlight"><pre># Run puppet and join our Consul cluster
resource &quot;aws_instance&quot; &quot;web&quot; {
    ...
    provisioner &quot;remote-exec&quot; {
        inline = [
        &quot;puppet apply&quot;,
        &quot;consul join ${aws_instance.web.private_ip}&quot;
        ]
    }
}
</pre></div>
<p>Here we are expressing that there is going to be a computing resource
  in AWS, and then when the resource is ready, the code block would be executed
  in that environment.</p>
<h1>Workloads scheduling</h1>
<h2>Kubernetes</h2>
<ul>
  <li>Docs:
    <ul>
      <li><a href="https://github.com/GoogleCloudPlatform/kubernetes/blob/master/examples/update-demo/nautilus-rc.yaml">https://github.com/GoogleCloudPlatform/kubernetes/blob/master/examples/update-demo/nautilus-rc.yaml</a></li>
    </ul>
  </li>
</ul>
<p>In the case of Kubernetes, the execution is driven via a YAML file.</p>
<p>A couple of examples below:</p>
<h4>Example: An Nginx service</h4>
<ul>
  <li>Explicitly say it is a <code>Service</code></li>
  <li>Describe the ports it will use</li>
  <li>Set a constraint about where to run the service</li>
</ul>
<div class="highlight"><pre><span class="l-Scalar-Plain">kind</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Service</span>
<span class="l-Scalar-Plain">apiVersion</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">v1beta1</span>
<span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx-example</span>
<span class="c1"># the port that this service should serve on</span>
<span class="l-Scalar-Plain">port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">8000</span>
<span class="c1"># just like the selector in the replication controller,</span>
<span class="c1"># but this time it identifies the set of pods to load balance</span>
<span class="c1"># traffic to.</span>
<span class="l-Scalar-Plain">selector</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx</span>
<span class="c1"># the container on each pod to connect to, can be a name</span>
<span class="c1"># (e.g. &#39;www&#39;) or a number (e.g. 80)</span>
<span class="l-Scalar-Plain">containerPort</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">80</span>
</pre></div>
<p>Not very clear what it is running, but it seems that
  an internal <code>containerport</code> will be exposed as the port 8000
  and that it will only be running in nodes tagged to be running <code>nginx</code> workloads.</p>
<p>The full example is <a href="https://github.com/GoogleCloudPlatform/kubernetes/commit/f1b55c04e2936fafb3c89d29dc474bb5b08f3673">here</a>.</p>
<h4>Example: A workload with a Healthcheck</h4>
<p>Here we have a container that has a <code>livenessProbe</code>,
  which can be done by either a command or a http request.
  The code block which</p>
<div class="highlight"><pre><span class="l-Scalar-Plain">apiVersion</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">v1beta1</span>
<span class="l-Scalar-Plain">desiredState</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">manifest</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">containers</span><span class="p-Indicator">:</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">busybox</span>
        <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">liveness</span>
        <span class="l-Scalar-Plain">livenessProbe</span><span class="p-Indicator">:</span>
          <span class="l-Scalar-Plain">exec</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span>
              <span class="p-Indicator">-</span> <span class="s">&quot;cat&quot;</span>
              <span class="p-Indicator">-</span> <span class="s">&quot;/tmp/health&quot;</span>
          <span class="l-Scalar-Plain">initialDelaySeconds</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">15</span>
        <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span>
          <span class="p-Indicator">-</span> <span class="s">&quot;/bin/sh&quot;</span>
          <span class="p-Indicator">-</span> <span class="s">&quot;-c&quot;</span>
          <span class="p-Indicator">-</span> <span class="s">&quot;echo</span><span class="nv"> </span><span class="s">ok</span><span class="nv"> </span><span class="s">&gt;</span><span class="nv"> </span><span class="s">/tmp/health;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">10;</span><span class="nv"> </span><span class="s">echo</span><span class="nv"> </span><span class="s">fail</span><span class="nv"> </span><span class="s">&gt;</span><span class="nv"> </span><span class="s">/tmp/health;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">600&quot;</span>
    <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">liveness-exec</span>
    <span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">v1beta1</span>
<span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">liveness-exec</span>
<span class="l-Scalar-Plain">kind</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Pod</span>
<span class="l-Scalar-Plain">labels</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">test</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">liveness</span>
</pre></div>
<h2>Marathon</h2>
<ul>
  <li>Docs:
    <ul>
      <li><a href="https://github.com/mesosphere/marathon">https://github.com/mesosphere/marathon</a></li>
    </ul>
  </li>
</ul>
<p>In Marathon, scheduling of workloads is done via <code>JSON</code> payloads done to an HTTP API.</p>
<p>Here is <a href="https://github.com/mesosphere/marathon/blob/master/examples/bridge.json">an example</a> of starting a couple of code blocks,
  one which does a healthcheck and another one which is the job itself.</p>
<div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;bridged-webapp&quot;</span><span class="p">,</span>
  <span class="s2">&quot;cmd&quot;</span><span class="o">:</span> <span class="s2">&quot;python3 -m http.server 8080&quot;</span><span class="p">,</span>
  <span class="s2">&quot;cpus&quot;</span><span class="o">:</span> <span class="mf">0.25</span><span class="p">,</span>
  <span class="s2">&quot;mem&quot;</span><span class="o">:</span> <span class="mf">64.0</span><span class="p">,</span>
  <span class="s2">&quot;instances&quot;</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="s2">&quot;container&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;DOCKER&quot;</span><span class="p">,</span>
    <span class="s2">&quot;docker&quot;</span><span class="o">:</span> <span class="p">{</span>
      <span class="s2">&quot;image&quot;</span><span class="o">:</span> <span class="s2">&quot;python:3&quot;</span><span class="p">,</span>
      <span class="s2">&quot;network&quot;</span><span class="o">:</span> <span class="s2">&quot;BRIDGE&quot;</span><span class="p">,</span>
      <span class="s2">&quot;portMappings&quot;</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span> <span class="s2">&quot;containerPort&quot;</span><span class="o">:</span> <span class="mi">8080</span><span class="p">,</span> <span class="s2">&quot;hostPort&quot;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;servicePort&quot;</span><span class="o">:</span> <span class="mi">9000</span><span class="p">,</span> <span class="s2">&quot;protocol&quot;</span><span class="o">:</span> <span class="s2">&quot;tcp&quot;</span> <span class="p">},</span>
        <span class="p">{</span> <span class="s2">&quot;containerPort&quot;</span><span class="o">:</span> <span class="mi">161</span><span class="p">,</span> <span class="s2">&quot;hostPort&quot;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;protocol&quot;</span><span class="o">:</span> <span class="s2">&quot;udp&quot;</span><span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="s2">&quot;healthChecks&quot;</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;protocol&quot;</span><span class="o">:</span> <span class="s2">&quot;HTTP&quot;</span><span class="p">,</span>
      <span class="s2">&quot;portIndex&quot;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="s2">&quot;path&quot;</span><span class="o">:</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span>
      <span class="s2">&quot;gracePeriodSeconds&quot;</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span>
      <span class="s2">&quot;intervalSeconds&quot;</span><span class="o">:</span> <span class="mi">20</span><span class="p">,</span>
      <span class="s2">&quot;maxConsecutiveFailures&quot;</span><span class="o">:</span> <span class="mi">3</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;protocol&quot;</span><span class="o">:</span> <span class="s2">&quot;COMMAND&quot;</span><span class="p">,</span>
      <span class="s2">&quot;command&quot;</span><span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;value&quot;</span><span class="o">:</span> <span class="s2">&quot;curl -f -X GET http://$HOST:$PORT&quot;</span> <span class="p">},</span>
      <span class="s2">&quot;gracePeriodSeconds&quot;</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span>
      <span class="s2">&quot;intervalSeconds&quot;</span><span class="o">:</span> <span class="mi">20</span><span class="p">,</span>
      <span class="s2">&quot;maxConsecutiveFailures&quot;</span><span class="o">:</span> <span class="mi">3</span>
    <span class="p">}</span>

  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
<p>Via the JSON configuration we are able to say transparently modify the execution of the code block and express
  that it should be done using a runtime which has <code>python:3</code> and a certain number of ports open.</p>
<p>For the healthcheck code block, it is defined the path and one liner that should be executed
  to consider that the other job is healthy or not.  It is also expressed that after 3 failures
  something would happen, though not expressed explicitly in the configuration.</p>
<h2>Thoughts</h2>
<p>Again, what I found interesting of all of these systems and tooling,
  is that they are variations around the same idea: wrap some configuration
  around the execution of a code block to transparently add some behavior
  to its execution.</p>
<p>Note: There are some technologies that I want to cover as well
  so I will be updating this post in the near future&#8230;</p>
<p>If you think I&#8217;m onto something you can follow me on <a href="https://twitter.com/wallyqs">Twitter</a>.</p>



  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/posts/2015/02/26/mesos-tokyo/">
        Talked at the Tokyo Mesos Meetup #1
      </a>
    </h1>

    <span class="post-date">26 Feb 2015</span>

    
<p>Yesterday it was held the first Mesos related even here in Tokyo.
  It seems that interest Mesos had accumulated for some time now around here,
  so the place quickly filled up even though it was the first event.</p>
<p>I gave a quick talk on some of the basics around writing schedulers for Mesos,
  (it has been a while since I presented in Japanese!). Slides below:</p>
<iframe src="//www.slideshare.net/slideshow/embed_code/45202017" width="476" height="400" frameborder="0" marginwidth="0" marginheight="0" scrolling="no"></iframe>



  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/posts/2015/02/25/ob-mesos/">
        Running Org Babel workloads on top of Mesos with Go and the Docker Containerizer
      </a>
    </h1>

    <span class="post-date">25 Feb 2015</span>

    
<p><img src="/public/mesos-tasks-output.png" alt="/public/mesos-tasks-output.png" /></p>
<p>One of the things that I left pending from my stay at
  <a href="https://www.hackerschool.com">HackerSchool</a>, was to combine a couple of the technologies
  that have caught most of my attention: <a href="http://mesos.apache.org/">Mesos</a> and <a href="http://orgmode.org/worg/org-contrib/babel/">Org mode</a>.</p>
<img src="/public/Mesos-Org.png" alt="/public/Mesos-Org.png" style="margin-left: auto; margin-right: auto; display: block;" />
<p>Although I&#8217;m a big fan of the literate programming and active documents
  that Org Babel enables for Emacs there are some limitations in the way
  it does it.  It works perfectly for local runs to get the results in
  place within Emacs, but it does not work very well for long running
  processes:</p>
<div class="org-src-container">

<pre class="src src-org"><span style="color: #465457; font-style: italic;">#+BEGIN_SRC sh</span>
<span style="color: #66D9EF;">while</span> true; <span style="color: #A6E22E;">echo</span> <span style="color: #E6DB74;">"hanging the Emacs session :P"</span>; <span style="color: #66D9EF;">done</span>
<span style="color: #465457; font-style: italic;">#+END_SRC</span>
</pre>
</div>
<p>Also in case you want to run a code block remotely,
  you need to do it via ssh.  Combining this with <code>#+call</code> blocks is
  still very cool though:</p>
<div class="org-src-container">

<pre class="src src-org"><span style="color: #465457; font-style: italic;">#+name: install-emacs</span>
<span style="color: #465457; font-style: italic;">#+BEGIN_SRC sh :dir /ubuntu@192.168.0.7:/home/ubuntu</span>
sudo apt-get update
sudo apt-get install -y emacs24-nox org-mode
<span style="color: #465457; font-style: italic;">#+END_SRC</span>

<span style="color: #465457; font-style: italic;">#+call: install-emacs() :dir /ubuntu@192.168.0.8:/home/ubuntu</span>
<span style="color: #465457; font-style: italic;">#+call: install-emacs() :dir /ubuntu@192.168.0.9:/home/ubuntu</span>
</pre>
</div>
<p>For some cases, like provisioning and installing packages (usually the
  domain of tools like Chef, Puppet, Ansible, etc&#8230;) this may work
  well, but for running jobs remotely we still have the same issue
  of the session hanging and running the code blocks sequentially:</p>
<div class="org-src-container">

<pre class="src src-org"><span style="color: #465457; font-style: italic;">#+name: run-remotely</span>
<span style="color: #465457; font-style: italic;">#+BEGIN_SRC sh :dir /ubuntu@192.168.0.7:/home/ubuntu</span>
<span style="color: #66D9EF;">while</span> true; <span style="color: #66D9EF;">do </span><span style="color: #A6E22E;">echo</span> <span style="color: #E6DB74;">"called sequentially, blocks, not really what we want"</span>; <span style="color: #66D9EF;">done</span>
<span style="color: #465457; font-style: italic;">#+END_SRC</span>

<span style="color: #465457; font-style: italic;">#+call: run-remotely() :dir /ubuntu@192.168.0.8:/home/ubuntu</span>
<span style="color: #465457; font-style: italic;">#+call: run-remotely() :dir /ubuntu@192.168.0.9:/home/ubuntu</span>
</pre>
</div>
<p>Not only that though, we also have to specify both the credentials
  and resources that we are using for running the workloads.
  Luckily, that is an area where Mesos really shines.</p>
<h3>Implementation using the Mesos Go bindings</h3>
<p>Mesos with its <i>level of indirection</i> approach, exposes a set of APIs
  that we can rely on to be able to write custom schedulers in a
  different runtime.  The <a href="https://github.com/mesos/mesos-go">mesos-go</a> bindings seem in actively development
  in particular, so I decided to base on those to write the scheduler.</p>
<p>Then, another thing we need is something which can understand Org mode
  documents, for this I implemented a basic parser of <a href="http://github.com/wallyqs/org-go">Org mode in Go</a>
  which can be loaded by the scheduler to orchestrate the run.</p>
<p>Using the Go bindings, we start defining our scheduler:</p>
<div class="highlight"><pre><span class="kd">type</span> <span class="nx">OrgBabelScheduler</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">tasksLaunched</span> <span class="kt">int</span>
	<span class="nx">tasksFinished</span> <span class="kt">int</span>
	<span class="nx">blocks</span>        <span class="p">[]</span><span class="o">*</span><span class="nx">org</span><span class="p">.</span><span class="nx">OrgSrcBlock</span>
<span class="p">}</span>
</pre></div>
<p>And below is a a basic example of how the <code>ResourceOffers</code>  handle
  would look.  Once having loaded the contents of the Org mode document,
  we will be inspecting the content of the code block its header
  arguments to procure the resources we want:</p>
<div class="highlight"><pre><span class="kd">func</span> <span class="p">(</span><span class="nx">sched</span> <span class="o">*</span><span class="nx">OrgBabelScheduler</span><span class="p">)</span> <span class="nx">ResourceOffers</span><span class="p">(</span><span class="nx">driver</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">SchedulerDriver</span><span class="p">,</span> <span class="nx">offers</span> <span class="p">[]</span><span class="o">*</span><span class="nx">mesos</span><span class="p">.</span><span class="nx">Offer</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// We will get many resource offerings,</span>
    <span class="c1">// but sometimes the resources being offered will not be enough</span>
    <span class="c1">// so we will need to implement backing off in case that happens.</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">offer</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">offers</span> <span class="p">{</span>

        <span class="o">...</span>

        <span class="kd">var</span> <span class="nx">tasks</span> <span class="p">[]</span><span class="o">*</span><span class="nx">mesos</span><span class="p">.</span><span class="nx">TaskInfo</span>

        <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">src</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">blocks</span> <span class="p">{</span>
                <span class="nx">sched</span><span class="p">.</span><span class="nx">tasksLaunched</span><span class="o">++</span>

                <span class="nx">taskId</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">mesos</span><span class="p">.</span><span class="nx">TaskID</span><span class="p">{</span>
                        <span class="nx">Value</span><span class="p">:</span> <span class="nx">proto</span><span class="p">.</span><span class="nx">String</span><span class="p">(</span><span class="nx">strconv</span><span class="p">.</span><span class="nx">Itoa</span><span class="p">(</span><span class="nx">sched</span><span class="p">.</span><span class="nx">tasksLaunched</span><span class="p">)),</span>
                <span class="p">}</span>

                <span class="c1">// Should build the command properly depending of the runtime</span>
                <span class="c1">// Currenty only sh supported, but good enough</span>
                <span class="c1">// since I can just call the runtime from there</span>
                <span class="nx">cmd</span> <span class="o">:=</span> <span class="nx">src</span><span class="p">.</span><span class="nx">RawContent</span>

                <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;[OFFER ] Executing this code block:&quot;</span><span class="p">,</span> <span class="nx">src</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">src</span><span class="p">.</span><span class="nx">Headers</span><span class="p">)</span>

                <span class="c1">// The code block specifies the resources it should allocate</span>
                <span class="c1">//</span>
                <span class="nx">taskCpus</span> <span class="o">:=</span> <span class="nx">MIN_CPUS_PER_TASK</span>
                <span class="k">if</span> <span class="nx">src</span><span class="p">.</span><span class="nx">Headers</span><span class="p">[</span><span class="s">&quot;:cpus&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span> <span class="p">{</span>
                  <span class="nx">taskCpus</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nx">Atoi</span><span class="p">(</span><span class="nx">src</span><span class="p">.</span><span class="nx">Headers</span><span class="p">[</span><span class="s">&quot;:cpus&quot;</span><span class="p">])</span>
                <span class="p">}</span>

                <span class="nx">taskMem</span> <span class="o">:=</span> <span class="nx">MIN_MEM_PER_TASK</span>
                <span class="k">if</span> <span class="nx">src</span><span class="p">.</span><span class="nx">Headers</span><span class="p">[</span><span class="s">&quot;:mem&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span> <span class="p">{</span>
                  <span class="nx">taskMem</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nx">Atoi</span><span class="p">(</span><span class="nx">src</span><span class="p">.</span><span class="nx">Headers</span><span class="p">[</span><span class="s">&quot;:mem&quot;</span><span class="p">])</span>
                <span class="p">}</span>

                <span class="nx">task</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">mesos</span><span class="p">.</span><span class="nx">TaskInfo</span><span class="p">{</span>
                        <span class="nx">Name</span><span class="p">:</span>     <span class="nx">proto</span><span class="p">.</span><span class="nx">String</span><span class="p">(</span><span class="s">&quot;ob-mesos-&quot;</span> <span class="o">+</span> <span class="nx">taskId</span><span class="p">.</span><span class="nx">GetValue</span><span class="p">()),</span>
                        <span class="nx">TaskId</span><span class="p">:</span>   <span class="nx">taskId</span><span class="p">,</span>
                        <span class="nx">SlaveId</span><span class="p">:</span>  <span class="nx">offer</span><span class="p">.</span><span class="nx">SlaveId</span><span class="p">,</span>
                        <span class="c1">// Executor: sched.executor,</span>
                        <span class="nx">Resources</span><span class="p">:</span> <span class="p">[]</span><span class="o">*</span><span class="nx">mesos</span><span class="p">.</span><span class="nx">Resource</span><span class="p">{</span>
                                <span class="nx">util</span><span class="p">.</span><span class="nx">NewScalarResource</span><span class="p">(</span><span class="s">&quot;cpus&quot;</span><span class="p">,</span> <span class="nb">float64</span><span class="p">(</span><span class="nx">taskCpus</span><span class="p">)),</span>
                                <span class="nx">util</span><span class="p">.</span><span class="nx">NewScalarResource</span><span class="p">(</span><span class="s">&quot;mem&quot;</span><span class="p">,</span> <span class="nb">float64</span><span class="p">(</span><span class="nx">taskMem</span><span class="p">)),</span>
                        <span class="p">},</span>
                        <span class="nx">Command</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">mesos</span><span class="p">.</span><span class="nx">CommandInfo</span><span class="p">{</span>
                                <span class="nx">Value</span><span class="p">:</span> <span class="nx">proto</span><span class="p">.</span><span class="nx">String</span><span class="p">(</span><span class="nx">cmd</span><span class="p">),</span>
                        <span class="p">},</span>
                <span class="p">}</span>

                <span class="c1">// Run within a Docker container if :dockerimage is specified</span>
                <span class="c1">//</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">src</span><span class="p">.</span><span class="nx">Headers</span><span class="p">[</span><span class="s">&quot;:dockerimage&quot;</span><span class="p">])</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
                        <span class="nx">task</span><span class="p">.</span><span class="nx">Container</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">mesos</span><span class="p">.</span><span class="nx">ContainerInfo</span><span class="p">{</span>
                                <span class="nx">Type</span><span class="p">:</span> <span class="nx">mesos</span><span class="p">.</span><span class="nx">ContainerInfo_DOCKER</span><span class="p">.</span><span class="nx">Enum</span><span class="p">(),</span>
                                <span class="nx">Docker</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">mesos</span><span class="p">.</span><span class="nx">ContainerInfo_DockerInfo</span><span class="p">{</span>
                                        <span class="nx">Image</span><span class="p">:</span> <span class="nx">proto</span><span class="p">.</span><span class="nx">String</span><span class="p">(</span><span class="nx">src</span><span class="p">.</span><span class="nx">Headers</span><span class="p">[</span><span class="s">&quot;:dockerimage&quot;</span><span class="p">]),</span>
					<span class="c1">// ...</span>
                                <span class="p">},</span>
                        <span class="p">}</span>
                <span class="p">}</span>

                <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;[OFFER ] Prepared to launch task:%s with offer %s \n&quot;</span><span class="p">,</span> <span class="nx">task</span><span class="p">.</span><span class="nx">GetName</span><span class="p">(),</span> <span class="nx">offer</span><span class="p">.</span><span class="nx">Id</span><span class="p">.</span><span class="nx">GetValue</span><span class="p">())</span>

                <span class="nx">tasks</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">tasks</span><span class="p">,</span> <span class="nx">task</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;[OFFER ] Launching &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">tasks</span><span class="p">),</span> <span class="s">&quot;tasks for offer&quot;</span><span class="p">,</span> <span class="nx">offer</span><span class="p">.</span><span class="nx">Id</span><span class="p">.</span><span class="nx">GetValue</span><span class="p">())</span>
        <span class="nx">driver</span><span class="p">.</span><span class="nx">LaunchTasks</span><span class="p">([]</span><span class="o">*</span><span class="nx">mesos</span><span class="p">.</span><span class="nx">OfferID</span><span class="p">{</span><span class="nx">offer</span><span class="p">.</span><span class="nx">Id</span><span class="p">},</span> <span class="nx">tasks</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">mesos</span><span class="p">.</span><span class="nx">Filters</span><span class="p">{</span><span class="nx">RefuseSeconds</span><span class="p">:</span> <span class="nx">proto</span><span class="p">.</span><span class="nx">Float64</span><span class="p">(</span><span class="mi">1</span><span class="p">)})</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>Full source of the implementation can be found <a href="https://github.com/wallyqs/mesos-notes/blob/master/org/org-scheduler.org">here</a>, written in
  literate programming with Org mode of course..</p>
<h3>Basic usage example: Running two commands in parallel</h3>
<p>A basic example, would be something like this:</p>
<div class="org-src-container">

<pre class="src src-org"><span style="color: #b3b3b3;">#+title:</span> <span style="color: #cafe12; font-size: 144%; font-weight: bold;">Example of running Org Babel workloads on Mesos</span>

<span style="color: #A6E22E;">*** Mesos settings</span>

<span style="color: #465457; font-style: italic;">#+address: 192.168.0.7</span>
<span style="color: #465457; font-style: italic;">#+master:  192.168.0.7:5050</span>

<span style="color: #A6E22E;">*** Code blocks</span>

<span style="color: #465457; font-style: italic;">#+name: hello-mesos</span>
<span style="color: #465457; font-style: italic;">#+header: :cpus 2 :mem 128</span>
<span style="color: #465457; font-style: italic;">#+BEGIN_SRC sh</span>
<span style="color: #66D9EF;">while</span> true; <span style="color: #66D9EF;">do</span> 
  <span style="color: #A6E22E;">echo</span> <span style="color: #E6DB74;">"hello world from Org Babel!!!"</span>
  sleep 1
<span style="color: #66D9EF;">done</span>
<span style="color: #465457; font-style: italic;">#+END_SRC</span>

<span style="color: #465457; font-style: italic;">#+name: date-example</span>
<span style="color: #465457; font-style: italic;">#+header: :cpus 2 :mem 256</span>
<span style="color: #465457; font-style: italic;">#+BEGIN_SRC sh</span>
<span style="color: #66D9EF;">while</span> true; <span style="color: #66D9EF;">do</span> 
  <span style="color: #A6E22E;">echo</span> <span style="color: #E6DB74;">"Telling the time!"</span>
  date
  sleep 1
<span style="color: #66D9EF;">done</span>
<span style="color: #465457; font-style: italic;">#+END_SRC</span>
</pre>
</div>
<p>Here, I am defining 2 code blocks, allocating 2 cpus to each.
  Also the second one will have a bit more memory than the other one.
  Only Mesos related configuration that we need is the location of a
  Mesos master and the ip address of the server from where we are
  running the scheduler.</p>
<h4>Results</h4>
<p>The end result of this experiment looks like this:</p>
<div class="highlight"><pre>$ go run examples/org_scheduler.go -f org/job.org -logtostderr=true 

...
[REGIST] Framework Registered with Master  &amp;MasterInfo{Id:*20150225-084641-117483712-5050-23902,Ip:*117483712,Port:*5050,Pid:*master@192.168.0.7:5050,Hostname:*192.168.0.7,XXX_unrecognized:[],}
[OFFER ] offerId = 20150225-084641-117483712-5050-23902-O60 , cpus = 4 , mem = 2812
[OFFER ] Executing this code block: hello-mesos map[:procs:5 :cpus:2 :mem:128]
[OFFER ] Prepared to launch task:ob-mesos-1 with offer 20150225-084641-117483712-5050-23902-O60 
[OFFER ] Executing this code block: date-example map[:cpus:2 :mem:256]
[OFFER ] Prepared to launch task:ob-mesos-2 with offer 20150225-084641-117483712-5050-23902-O60 
[OFFER ] Launching  2 tasks for offer 20150225-084641-117483712-5050-23902-O60
[STATUS] task 1  is in state  TASK_RUNNING
[STATUS] task 2  is in state  TASK_RUNNING
</pre></div>
<p>We can also check the logs within the Mesos slave sandbox:</p>
<p><img src="/public/mesos-tasks.png" alt="/public/mesos-tasks.png" /></p>
<h3>Containerizer usage example: Running a command within a Docker container</h3>
<p>Thanks to the built-in Docker containerizer from Mesos,
  it would also be possible to specify a Docker image so
  that the command gets executed within a container.</p>
<p>In this example, the first block will specify the entrypoint and set
  <code>:dockerimage redis</code> so that the redis image is pulled and ran.</p>
<p>Then the second one will be using that redis container and updating a timestamp.</p>
<div class="org-src-container">

<pre class="src src-org"><span style="color: #b3b3b3;">#+title:</span>   <span style="color: #cafe12; font-size: 144%; font-weight: bold;">Org + Docker + Mesos + Redis Example</span>
<span style="color: #465457; font-style: italic;">#+address: 192.168.0.7</span>
<span style="color: #465457; font-style: italic;">#+master:  192.168.0.7:5050</span>

Here is a redis server, we can define the entrypoint to be used
within the Docker image via an Org Babel block:

<span style="color: #465457; font-style: italic;">#+name: redis-server</span>
<span style="color: #465457; font-style: italic;">#+header: :cpus 2 :mem 512 :dockerimage redis</span>
<span style="color: #465457; font-style: italic;">#+BEGIN_SRC sh</span>
redis-server
<span style="color: #465457; font-style: italic;">#+END_SRC</span>

In parallel, there will be another job running
which will be setting the time in the redis server:

<span style="color: #465457; font-style: italic;">#+name: set-time-in-redis</span>
<span style="color: #465457; font-style: italic;">#+header: :cpus 2 :mem 256</span>
<span style="color: #465457; font-style: italic;">#+BEGIN_SRC sh</span>
<span style="color: #66D9EF;">while</span> true; <span style="color: #66D9EF;">do</span> 
  <span style="color: #A6E22E;">echo</span> <span style="color: #E6DB74;">"SET time `date '+%s'`"</span> | nc 127.0.0.1 6379
  sleep 1
<span style="color: #66D9EF;">done</span>
<span style="color: #465457; font-style: italic;">#+END_SRC</span>
</pre>
</div>
<h4>Results</h4>
<p>Output would be:</p>
<div class="highlight"><pre>[OFFER ] offerId = 20150225-174751-117483712-5050-13334-O1376 , cpus = 4 , mem = 2812
[OFFER ] Executing this code block: redis-server map[:mem:512 :dockerimage:redis :cpus:2]
[OFFER ] Prepared to launch task:ob-mesos-1 with offer 20150225-174751-117483712-5050-13334-O1376 
[OFFER ] Executing this code block: set-time-in-redis map[:mem:256 :cpus:2]
[OFFER ] Prepared to launch task:ob-mesos-2 with offer 20150225-174751-117483712-5050-13334-O1376 
[OFFER ] Launching  2 tasks for offer 20150225-174751-117483712-5050-13334-O1376
[STATUS] task 2  is in state  TASK_RUNNING
[STATUS] task 1  is in state  TASK_RUNNING
[OFFER ] offerId = 20150225-174751-117483712-5050-13334-O1377 , cpus = 0 , mem = 2044
</pre></div>
<p>And we can also confirm that it has been run by the Docker engine:</p>
<div class="highlight"><pre>sudo docker ps

CONTAINER ID        IMAGE               COMMAND                CREATED             STATUS              PORTS               NAMES
1a8b3c964c3e        redis:latest        <span class="err">&quot;</span><span class="se">\&quot;</span>/bin/sh -c redis-   17 minutes ago      Up 17 minutes                           mesos-88de0870-b613-4bda-9ed4-30995834ccab
</pre></div>
<p>and that a timestamp has been set:</p>
<div class="highlight"><pre>telnet 127.0.0.1 6379

Trying 127.0.0.1...
Connected to 127.0.0.1.
Escape character is <span class="s1">&#39;^]&#39;</span>.
get <span class="nb">time</span>
<span class="nv">$10</span>
1424882889
</pre></div>
<p>We can also check the logs within the sandbox:</p>
<div class="highlight"><pre>==&gt; /tmp/mesos/slaves/20150223-223304-117483712-5050-29395-S0/frameworks/20150225-174751-117483712-5050-13334-0018/executors/1/runs/88de0870-b613-4bda-9ed4-30995834ccab/stdout &lt;==
[8] 25 Feb 16:25:07.322 # Warning: no config file specified, using the default config. In order to specify a config file use redis-server /path/to/redis.conf
                _._
           _.-``__ &#39;&#39;-._
      _.-``    `.  `_.  &#39;&#39;-._           Redis 2.8.17 (00000000/0) 64 bit
  .-`` .-```.  ```\/    _.,_ &#39;&#39;-._
 (    &#39;      ,       .-`  | `,    )     Running in stand alone mode
 |`-._`-...-` __...-.``-._|&#39;` _.-&#39;|     Port: 6379
 |    `-._   `._    /     _.-&#39;    |     PID: 8
  `-._    `-._  `-./  _.-&#39;    _.-&#39;
 |`-._`-._    `-.__.-&#39;    _.-&#39;_.-&#39;|
 |    `-._`-._        _.-&#39;_.-&#39;    |           http://redis.io
  `-._    `-._`-.__.-&#39;_.-&#39;    _.-&#39;
 |`-._`-._    `-.__.-&#39;    _.-&#39;_.-&#39;|
 |    `-._`-._        _.-&#39;_.-&#39;    |
  `-._    `-._`-.__.-&#39;_.-&#39;    _.-&#39;
      `-._    `-.__.-&#39;    _.-&#39;
          `-._        _.-&#39;
              `-.__.-&#39;

[8] 25 Feb 16:25:07.349 # Server started, Redis version 2.8.17
</pre></div>
<h3>Conclusion</h3>
<p>But, why even use Org mode for this?  Well, the best thing I think
  that it has for it is that we are <b>adding value transparently</b> to the
  way that we are executing our workloads along with its description.</p>
<p>By having a document format where code blocks are first class citizen,
  we can both manipulate the way we run something without losing the
  thought process of how we ran it in the first place (since human writing also
  first class citizen), thus emphasizing both reproducibility and readability.</p>
<p>Locally, the code blocks would still eval
  using the Org mode active document features, but by dispatching it to
  something like the <code>OrgBabelScheduler</code>, we can just <i>lift</i> those code blocks and run
  them in a distributed fashion.</p>
<p>There are still some ideas I have around this and the possibilites
  that it would open around <i>reproducible research</i>.</p>
<p>Feedback is very welcome! You can also follow me on <a href="https://twitter.com/wallyqs">Twitter</a> if you
  find this interesting&#8230;</p>



  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/posts/2014/12/25/learning-go-backwards/">
        About type switch usage in Go
      </a>
    </h1>

    <span class="post-date">25 Dec 2014</span>

    
<p>One of the features that I have been relying a lot in Go is the <a href="https://golang.org/doc/effective_go.html#type_switch">type switch</a>.
  This feature is specially useful when using interfaces since it helps us avoid having to do type assertions all the time.</p>
<p>A couple of examples below.</p>
<h3>Example #1</h3>
<p>Let&#8217;s suppose that we have 3 types <code>A</code>, <code>B</code> &amp; <code>C</code>,
  where each one of these types can be assigned a <code>Name</code>:</p>
<div class="highlight"><pre><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
  <span class="s">&quot;fmt&quot;</span>
  <span class="s">&quot;reflect&quot;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">A</span> <span class="kd">struct</span> <span class="p">{</span> <span class="nx">Name</span> <span class="kt">string</span> <span class="p">}</span>
<span class="kd">type</span> <span class="nx">B</span> <span class="kd">struct</span> <span class="p">{</span> <span class="nx">Name</span> <span class="kt">string</span> <span class="p">}</span>
<span class="kd">type</span> <span class="nx">C</span> <span class="kd">struct</span> <span class="p">{</span> <span class="nx">Name</span> <span class="kt">string</span> <span class="p">}</span>
</pre></div>
<p>And we put them inside of a slice which can contain <code>interfaces</code>:</p>
<div class="highlight"><pre><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>

  <span class="nx">a</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">A</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="s">&quot;A&quot;</span><span class="p">}</span>
  <span class="nx">b</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">B</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="s">&quot;B&quot;</span><span class="p">}</span>
  <span class="nx">c</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">C</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="s">&quot;C&quot;</span><span class="p">}</span>

  <span class="nx">t</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kd">interface</span><span class="p">{},</span> <span class="mi">0</span><span class="p">)</span>
  <span class="nx">t</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">a</span><span class="p">)</span>
  <span class="nx">t</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span>
  <span class="nx">t</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span>
</pre></div>
<h4>Without using <code>type switch</code></h4>
<p>We would end up doing something like this:</p>
<div class="highlight"><pre><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;--- without type switching&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">thing</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">t</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="nx">thing</span><span class="p">.(</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">*</span><span class="nx">A</span><span class="p">:</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">thing</span><span class="p">),</span> <span class="s">&quot;is of type A. Name is:&quot;</span><span class="p">,</span> <span class="nx">thing</span><span class="p">.(</span><span class="o">*</span><span class="nx">A</span><span class="p">).</span><span class="nx">Name</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">*</span><span class="nx">B</span><span class="p">:</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">thing</span><span class="p">),</span> <span class="s">&quot;is of type B. Name is:&quot;</span><span class="p">,</span> <span class="nx">thing</span><span class="p">.(</span><span class="o">*</span><span class="nx">B</span><span class="p">).</span><span class="nx">Name</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">*</span><span class="nx">C</span><span class="p">:</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">thing</span><span class="p">),</span> <span class="s">&quot;is of type C. Name is:&quot;</span><span class="p">,</span> <span class="nx">thing</span><span class="p">.(</span><span class="o">*</span><span class="nx">C</span><span class="p">).</span><span class="nx">Name</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<h5>Results</h5>
<pre class="example">
--- without type switching
*main.A is of type A. Name is: A
*main.B is of type B. Name is: B
*main.C is of type C. Name is: C
</pre>
<h4>Using a <code>type switch</code></h4>
<p>Makes things a little more bearable:</p>
<div class="highlight"><pre><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;--- type switching on the item&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">thing</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">t</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="nx">o</span> <span class="o">:=</span> <span class="nx">thing</span><span class="p">.(</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">*</span><span class="nx">A</span><span class="p">:</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">o</span><span class="p">),</span> <span class="s">&quot;is of type A. Name is:&quot;</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">*</span><span class="nx">B</span><span class="p">:</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">o</span><span class="p">),</span> <span class="s">&quot;is of type B. Name is:&quot;</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">*</span><span class="nx">C</span><span class="p">:</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">o</span><span class="p">),</span> <span class="s">&quot;is of type C. Name is:&quot;</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<h5>Results</h5>
<pre class="example">
--- type switching on the item
*main.A is of type A. Name is: A
*main.B is of type B. Name is: B
*main.C is of type C. Name is: C
</pre>
<h3>Example #2</h3>
<p>Let&#8217;s see how far we can take it.
  Now, let&#8217;s suppose that we want to handle A and B the same way.</p>
<h4>Using <code>type switch</code>, it works too</h4>
<p>Since we want to handle <code>A</code> and <code>B</code> the same way, we could think
  that we could group them into the same <code>case</code>, which would work:</p>
<div class="highlight"><pre><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;--- Grouping A and B: &quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">thing</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">t</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="nx">o</span> <span class="o">:=</span> <span class="nx">thing</span><span class="p">.(</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">*</span><span class="nx">A</span><span class="p">,</span> <span class="o">*</span><span class="nx">B</span><span class="p">:</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">o</span><span class="p">),</span> <span class="s">&quot;is of type A or B.&quot;</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">*</span><span class="nx">C</span><span class="p">:</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">o</span><span class="p">),</span> <span class="s">&quot;is of type C.&quot;</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<h5>Results</h5>
<pre class="example">
*main.A is of type A or B.
*main.B is of type A or B.
*main.C is of type C.
</pre>
<h4>Until it doesn&#8217;t</h4>
<p>Let&#8217;s suppose that we want to inspect the value of the <code>Name</code> field. Then it breaks:</p>
<div class="highlight"><pre><span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">thing</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">t</span> <span class="p">{</span>
	<span class="k">switch</span> <span class="nx">o</span> <span class="o">:=</span> <span class="nx">thing</span><span class="p">.(</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="o">*</span><span class="nx">A</span><span class="p">,</span> <span class="o">*</span><span class="nx">B</span><span class="p">:</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">o</span><span class="p">),</span> <span class="s">&quot;is of type A or B. Name is:&quot;</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
	<span class="k">case</span> <span class="o">*</span><span class="nx">C</span><span class="p">:</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">o</span><span class="p">),</span> <span class="s">&quot;is of type C. Name is:&quot;</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>The above would throw the following error:</p>
<pre class="example">
o.Name undefined (type interface {} has no field or method Name)
</pre>
<h4>Back to <code>interface</code></h4>
<p>What happened here is that by trying to group <code>A</code>, <code>B</code> types, we ended up again
  with an <code>interface</code>, so we cannot rely on the first type switch anymore.</p>
<p>We could type switch once more time then:</p>
<div class="highlight"><pre><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;--- Double type switch all the way&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">thing</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">t</span> <span class="p">{</span>
	<span class="k">switch</span> <span class="nx">o</span> <span class="o">:=</span> <span class="nx">thing</span><span class="p">.(</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="o">*</span><span class="nx">A</span><span class="p">,</span> <span class="o">*</span><span class="nx">B</span><span class="p">:</span>
		<span class="k">switch</span> <span class="nx">oo</span> <span class="o">:=</span> <span class="nx">o</span><span class="p">.(</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="o">*</span><span class="nx">A</span><span class="p">:</span>
			<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">o</span><span class="p">),</span> <span class="s">&quot;is of type A or B. Name is:&quot;</span><span class="p">,</span> <span class="nx">oo</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
		<span class="k">case</span> <span class="o">*</span><span class="nx">B</span><span class="p">:</span>
			<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">o</span><span class="p">),</span> <span class="s">&quot;is of type A or B. Name is:&quot;</span><span class="p">,</span> <span class="nx">oo</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="o">*</span><span class="nx">C</span><span class="p">:</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">o</span><span class="p">),</span> <span class="s">&quot;is of type C. Name is:&quot;</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></div>
<h5>Results</h5>
<div class="highlight"><pre>--- Double type switch all the way
*main.A is of type A or B. Name is: A
*main.B is of type A or B. Name is: B
*main.C is of type C. Name is: C
</pre></div>
<p>&#8230;which looks a bit messy. A more straightforward way would be to
  flinch away our desire to make things &#8220;DRY&#8221;, still rely on the first type switch
  and just repeat more code:</p>
<div class="highlight"><pre><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;--- The Go Way&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">thing</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">t</span> <span class="p">{</span>
	<span class="k">switch</span> <span class="nx">o</span> <span class="o">:=</span> <span class="nx">thing</span><span class="p">.(</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="o">*</span><span class="nx">A</span><span class="p">:</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">o</span><span class="p">),</span> <span class="s">&quot;is of type A or B. Name is:&quot;</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
	<span class="k">case</span> <span class="o">*</span><span class="nx">B</span><span class="p">:</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">o</span><span class="p">),</span> <span class="s">&quot;is of type A or B. Name is:&quot;</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
	<span class="k">case</span> <span class="o">*</span><span class="nx">C</span><span class="p">:</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">o</span><span class="p">),</span> <span class="s">&quot;is of type C. Name is:&quot;</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>&#8230;which results in:</p>
<pre class="example">
--- The Go Way
*main.A is of type A or B. Name is: A
*main.B is of type A or B. Name is: B
*main.C is of type C. Name is: C
</pre>
<h3>Progress so far</h3>
<p>So which one of the approaches is better?</p>
<p>I would say that probably the one with the
  multiple case statements where the same line is repeated, since when
  we type switch and have a <code>case</code> statement with one more type,
  we end up once again with an <code>interface</code>, and we need yet another <code>type switch</code>
  for it that generates more code which more or less says the
  same thing, so it seems that it is about as DRY as it could get
  for now using only <code>type switch</code>.</p>
<p><a href="https://play.golang.org/p/PEsLe_ZRzE">Link to the Go playground with the example</a></p>
<p>To solve the grouping problem, there is something else that we can
  try besides only using the <code>type switch</code>, which is using <code>interface</code> types.</p>
<h3>Example #3</h3>
<p>Another alternative would be to use a <code>Nameable</code> interface when creating the slice.
  This means first having to declare something like this:</p>
<div class="highlight"><pre><span class="kd">type</span> <span class="nx">Nameable</span> <span class="kd">interface</span> <span class="p">{</span>
  <span class="nx">GetName</span><span class="p">()</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">BasicAttrs</span> <span class="kd">struct</span> <span class="p">{</span> 
  <span class="nx">Name</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="c1">// Code generation could help with this...</span>
<span class="kd">type</span> <span class="nx">A</span> <span class="kd">struct</span> <span class="p">{</span> <span class="nx">BasicAttrs</span> <span class="p">}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">o</span> <span class="o">*</span><span class="nx">A</span><span class="p">)</span> <span class="nx">GetName</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Name</span> <span class="p">}</span>

<span class="kd">type</span> <span class="nx">B</span> <span class="kd">struct</span> <span class="p">{</span> <span class="nx">BasicAttrs</span> <span class="p">}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">o</span> <span class="o">*</span><span class="nx">B</span><span class="p">)</span> <span class="nx">GetName</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Name</span> <span class="p">}</span>

<span class="kd">type</span> <span class="nx">C</span> <span class="kd">struct</span> <span class="p">{</span> <span class="nx">BasicAttrs</span> <span class="p">}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">o</span> <span class="o">*</span><span class="nx">C</span><span class="p">)</span> <span class="nx">GetName</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Name</span> <span class="p">}</span>
</pre></div>
<p>So that we can later on use it as follows:</p>
<div class="highlight"><pre><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>

	<span class="nx">a</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">A</span><span class="p">{</span><span class="nx">BasicAttrs</span><span class="p">:</span><span class="nx">BasicAttrs</span> <span class="p">{</span> <span class="nx">Name</span><span class="p">:</span> <span class="s">&quot;A&quot;</span> <span class="p">}}</span>
	<span class="nx">b</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">B</span><span class="p">{</span><span class="nx">BasicAttrs</span><span class="p">:</span><span class="nx">BasicAttrs</span> <span class="p">{</span> <span class="nx">Name</span><span class="p">:</span> <span class="s">&quot;B&quot;</span> <span class="p">}}</span>
	<span class="nx">c</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">C</span><span class="p">{</span><span class="nx">BasicAttrs</span><span class="p">:</span><span class="nx">BasicAttrs</span> <span class="p">{</span> <span class="nx">Name</span><span class="p">:</span> <span class="s">&quot;C&quot;</span> <span class="p">}}</span>

	<span class="nx">t</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">Nameable</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
	<span class="nx">t</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">a</span><span class="p">)</span>
	<span class="nx">t</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span>
	<span class="nx">t</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span>

	<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;--- The correct Go way?&quot;</span><span class="p">)</span>
	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">thing</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">t</span> <span class="p">{</span>
	<span class="k">switch</span> <span class="nx">o</span> <span class="o">:=</span> <span class="nx">thing</span><span class="p">.(</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span>
	   <span class="k">case</span> <span class="o">*</span><span class="nx">A</span><span class="p">,</span> <span class="o">*</span><span class="nx">B</span><span class="p">:</span>
	      <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">o</span><span class="p">),</span> <span class="s">&quot;is of type A or B. Name is:&quot;</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">GetName</span><span class="p">())</span>
	   <span class="k">case</span> <span class="o">*</span><span class="nx">C</span><span class="p">:</span>
	     <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">o</span><span class="p">),</span> <span class="s">&quot;is of type C. Name is:&quot;</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">GetName</span><span class="p">())</span>
	  <span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></div>
<h5>Results</h5>
<pre class="example">
--- The correct Go way?
*main.A is of type A or B. Name is: A
*main.B is of type A or B. Name is: B
*main.C is of type C. Name is: C
</pre>
<h3>Is this better?</h3>
<p>I think so.  Even though the implementation is a bit more verbose, the last example using a <code>type interface</code>
  might be the way to go in case we face the grouping issue from the raw interface.</p>



  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/posts/2014/12/12/using-tcpdump/">
        Quickly inspecting HTTP traffic with tcpdump
      </a>
    </h1>

    <span class="post-date">12 Dec 2014</span>

    
<p>Just a quick post on one of my favorite features of <code>tcpdump</code> that I
  have found useful for doing quick investigations of the behavior of an app
  and you need a little bit more than what you get with the access logs.</p>
<p>Wireshark has this <a href="http://www.wireshark.org/tools/string-cf.html">great site</a> that given a HTTP request,
  will give you a filter that if paired with the <code>-A</code> (print packet in ASCII) option from <code>tcpdump</code>
  will match all related HTTP traffic that is going on in a node.</p>
<p>A couple of basic examples:</p>
<ul>
  <li>Show all <code>GET</code> requests</li>
</ul>
<div class="highlight"><pre>tcpdump -A <span class="s1">&#39;tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):2] = 0x4745 &amp;&amp; tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2) + 2:1] = 0x54&#39;</span>

tcpdump: verbose output suppressed, use -v or -vv <span class="k">for </span>full protocol decode
listening on wlan0, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, capture size 65535 bytes
16:31:54.870479 IP 10.0.1.134.56724 &gt; 10.0.7.64.http-alt: Flags <span class="o">[</span>P.<span class="o">]</span>, seq 1988783165:1988783563, ack 2609786817, win 65535, options <span class="o">[</span>nop,nop,TS val 703013338 ecr 40647638<span class="o">]</span>, length 398
E...Bt@.@...
...
..@....v.l<span class="o">=</span>../............
<span class="o">)</span>.!..l<span class="p">;</span>.GET /v2/apps HTTP/1.1
Host: 10.0.77.64:8080
Connection: keep-alive
Accept: application/json, text/javascript, */*<span class="p">;</span> <span class="nv">q</span><span class="o">=</span>0.01
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 <span class="o">(</span>Macintosh<span class="p">;</span> Intel Mac OS X 10_7_5<span class="o">)</span> AppleWebKit/537.36 <span class="o">(</span>KHTML, like Gecko<span class="o">)</span> Chrome/39.0.2171.71 Safari/537.36
Referer: http://10.0.7.64:8080/
Accept-Encoding: gzip, deflate, sdch
Accept-Language: en-US,en<span class="p">;</span><span class="nv">q</span><span class="o">=</span>0.8
</pre></div>
<ul>
  <li>Show all <code>POST</code> requests</li>
</ul>
<div class="highlight"><pre>tcpdump -A <span class="s1">&#39;tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x504f5354&#39;</span>

tcpdump: verbose output suppressed, use -v or -vv <span class="k">for </span>full protocol decode
listening on wlan0, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, capture size 65535 bytes
16:41:59.925399 IP 10.0.1.134.56765 &gt; 10.0.7.64.http-alt: Flags <span class="o">[</span>P.<span class="o">]</span>, seq 1595944397:1595945056, ack 1073928153, win 65535, options <span class="o">[</span>nop,nop,TS val 703610055 ecr 40792556<span class="o">]</span>, length 659
E.....@.@.o.
...
..@...._ -.@..............
<span class="o">)</span>.&lt;..nq.POST /v2/apps HTTP/1.1
Host: 10.0.77.64:8080
Connection: keep-alive
Content-Length: 182
Accept: application/json, text/javascript, */*<span class="p">;</span> <span class="nv">q</span><span class="o">=</span>0.01
Origin: http://10.0.7.64:8080
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 <span class="o">(</span>Macintosh<span class="p">;</span> Intel Mac OS X 10_7_5<span class="o">)</span> AppleWebKit/537.36 <span class="o">(</span>KHTML, like Gecko<span class="o">)</span> Chrome/39.0.2171.71 Safari/537.36
Content-Type: application/json
Referer: http://10.0.7.64:8080/
Accept-Encoding: gzip, deflate
Accept-Language: en-US,en<span class="p">;</span><span class="nv">q</span><span class="o">=</span>0.8
</pre></div>
<p>You can add more info to the path (e.g. <code>GET /v2/</code>) to narrow down the actions
  that are being investigated.</p>



  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page2">Older</a>
  
  
    <span class="pagination-item newer">Newer</span>
  
</div>
    </div>

  </body>
</html>
